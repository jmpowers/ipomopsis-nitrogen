---
title: "Ipomopsis nitrogen experiment 1 volatiles"
author: "Janelle Bohey, John Powers"
date: "`r Sys.Date()`"
output: 
  html_document:
    self_contained: no
    lib_dir: libs
    code_folding: hide
    toc: yes
    toc_float: TRUE 
editor_options: 
  chunk_output_type: console
---
<style type="text/css">
.main-container { max-width: 1000px; margin-left: 0; margin-right: auto; }
img{ max-width:200%; height: auto; }
td, th { padding : 6px }
</style>

# This has correct quant integrations and full compound list
# Speciestime & treatment grouping instead of species, time, treatment
#34 compounds with quantitative integrations

=======
#janelle was here
#arturo was here

```{r setup, include=FALSE}
library(reshape2)
library(tidyverse)
library(lubridate)
library(vegan)
library(knitr)
#install.packages("remotes")
#remotes::install_github("jmpowers/bouquet", build_vignettes = TRUE)
library(bouquet)
knitr::opts_chunk$set(comment="", cache=T, warning=F, message=F, 
                      fig.path = "plots-nitrogen/", dev="svglite", dev.args=list(fix_text_size=FALSE), fig.height=8, fig.width=10)
```

```{r read_scents}
library(googlesheets4)
exp1_meta <- read_sheet("1k2XJUsRyTsQEeEoZE24yTvsl7kSyf2Gg6gehs8pUvOo", sheet="metadata", guess_max=200) %>% #sheet selects "metadata" sheet on Google Sheets, guess_max reads 200 lines before program guesses the type of each column (string vs integer vs date)
  mutate(plant = as.character(plant))

exp2_meta <- read_sheet("1EwPMsBAxqrRtuqH4uUBtthUOZlQluQICSvNr9u87h0E", sheet="metadata", guess_max=200) %>%
  mutate(plant = as.character(plant))

exp1_field_meta <- read_sheet("", guess_max=200) %>%
  mutate(plant = as.character(plant))

gc_verdicts <- read_sheet("1X8oo7qZlo1p6MVl_CBeBe6CUTHEAcd-FWQzfHud3Qws", sheet = "2022gc220929") %>% #verdicts = the truth of the skips, renames all skips in R 
  mutate(sample2 = ifelse(is.na(sample), FileName, sample))
#verdicts 
exp1_verdicts <- gc_verdicts %>% filter(sample2 %in% exp1_meta$filename) #sample2= if sample is blank on metadata then its the filename no renaming necessary but if sample has a filename then something before it skipped and your re lining up/ accounting for skip (translating between the filename you want and the filename you have) 
exp2leaf_verdicts <- gc_verdicts %>% filter(sample2 %in% exp2_meta$filename)
exp1_field_verdicts <- gc_verdicts %>% filter(sample2 %in% exp1_field_meta$filename)

write_csv(exp1_verdicts, file = "data/exp1_verdicts.csv")
write_csv(exp2leaf_verdicts, file = "data/exp2leaf_verdicts.csv")
write_csv(exp1_verdicts, file = "data/exp1_field_verdicts.csv")

#load("~/MyDocs/MEGA/UCI/Schiedea/Analysis/scent/rmbl/Inventory/shimadzu_data_22.rda") #loading old quant integrations from John's computer
source("read_shimadzu.R") #loads the function that reads the shimadzu output text file
shimadzu.data.22 <- read.shimadzu.quant("data/NEXP1_field_greenhouse_quant.txt") #reads in shimadzu text file with quant integrations

#exp1.data = greenhouse N experiment data only
#pg.data= field N experiment at Poverty Gulch data only 

exp1.data <- shimadzu.data.22 %>% filter(Filename %in% exp1_verdicts$FileName) #
exp2leaf.data <- shimadzu.data.22 %>% filter(Filename %in% exp2_verdicts$FileName)
exp1.field.data <- shimadzu.data.22 %>% filter(Filename %in% exp1_field_verdicts$FileName)
save(exp1.data, file = "data/exp1_data.rda")
save(exp2leaf.data, file = "data/exp2leaf_data.rda")
save(exp1.field.data, file = "data/exp1_field_data.rda")

exp1.verdicts <- read_csv("data/exp1_verdicts.csv")
load("data/exp1_data.rda") #loads exp1.data (Shimadzu output)

exp1.data <- exp1.data %>% left_join(select(exp1.verdicts, Filename = FileName, sample2)) %>% 
  select(-Filename) %>% rename(Filename = sample2) %>%  #replace FileName with the sample2 it holds (accounts for skips)
  droplevels()

exp1.field.verdicts <- read_csv("data/exp1_field_verdicts.csv")
load("data/exp1_field_data.rda") #loads exp1.field.data (Shimadzu output)

exp1.field.data <- exp1.field.data %>% left_join(select(exp1.field.verdicts, Filename = FileName, sample2)) %>% 
  select(-Filename) %>% rename(Filename = sample2) %>%  #replace FileName with the sample2 it holds (accounts for skips)
  droplevels()

# load short names
ipochems <- read_csv("data/Ipo volatile compounds - chemsf_ipo.csv") %>% 
  select(name, shortname, standard, verdict) %>%  filter(verdict != "")
            
#shorten chemical names and merge compounds with multiple names
shortnames <- ipochems %>% select(name, shortname) %>% filter(shortname!="") %>% deframe()

exp1.data$Name <- recode(exp1.data$Name, !!!shortnames)

exp1.all <- dcast(exp1.data, Filename~Name, sum, value.var="Area")
rownames(exp1.all) <- exp1.all[,1]
exp1.all[,1] <- NULL
```

# Read metadata

```{r metadata, fig.height=5, fig.width=5}
metadata <- read_csv("data/EXP 1 (N) Volatile sampling  - metadata.csv") %>% 
  filter(filename != "#N/A") %>% 
  mutate(plantid = paste(species, plant), speciestime = paste(species, time, sep=".")) %>% 
  left_join(read_csv("data/exp1_treatments.csv") %>% mutate(plant = as.character(plant)))
rownames(metadata) <- metadata$filename
metadata <- metadata[rownames(exp1.all),] #order metaddata to match order of data

metadata %>% count(species, time, treatment) %>% kable()
metadata %>% filter(species !="AMB") %>% count(species, plantid, time) %>% 
  ggplot(aes(x=n, fill=time))+ geom_histogram(binwidth=1) + facet_wrap(vars(time), ncol=1)+
  labs(x="Samples per plant") 

metadata %>% filter(species !="AMB") %>% group_by(time) %>% 
  mutate(pump.dt = ymd_hms(paste(date, pump)), pump.hr = hour(pump.dt)+minute(pump.dt)/60,
         bag.dt = ymd_hms(paste(date, bag)), bag.hr = hour(bag.dt)+minute(bag.dt)/60,
         end.dt = ymd_hms(paste(date, bag)), end.hr = hour(end.dt)+minute(end.dt)/60) %>% 
  summarize(min=min(bag.hr), max=max(end.hr))  %>% kable(caption="first bag time, last ending time, in hr", digits=2)

ggplot(metadata, aes(y=equil, x=species)) + geom_boxplot() + labs(y="Equilibration duration")
ggplot(metadata, aes(y=pumping, x=species)) + geom_boxplot() + labs(y="Pumping duration")

metadata %>% count(species) %>% kable(caption="total volatile samples by species")

digging_date <- ymd("2022-06-24")
treatment_date <- digging_date + days(6)
ggplot(metadata, aes(x=date-treatment_date, fill=species))+geom_histogram(binwidth=1)
metadata %>% count(date-treatment_date) %>% kable(caption=paste("days since treatments began on", treatment_date))
```

# Filtering

```{r filtering}
metadata <- metadata %>% mutate(type= ifelse(species=="AMB", "ambient","floral")) %>% rename(trap=sample) %>% as.data.frame() %>% 
  load_metadata(date = "date", sample = "filename", group = "speciestime", type = "type") #combine species and time (previously separate)

longdata <- load_longdata(exp1.data, sample = "Filename", RT = "Ret.Time", 
                          name = "Name", area = "Area", match = "SI", maxmatch=100)

sampletable <- make_sampletable(longdata, metadata)

chemtable <- make_chemtable(longdata, metadata) %>% 
  filter_RT(2, 17) %>% 
  filter_match(0.8) %>% 
  filter_freq(0.2, group = TRUE) %>% 
  filter_contaminant(cont.list = c("13-Methyltetradecanal","Cyclohexane, 1,1-dimethyl-2-propyl-","2-hexyldecan-1-ol","Tridecane, 3-methylene-")) %>% 
  filter_area(min_maximum = 1e5) %>%
  filter_ambient_ratio(sampletable, metadata, ratio = 3) %>% 
  filter_ambient_ttest(sampletable, metadata, 
                       alpha = 0.05, adjust = "fdr") 
chemtable$filter_final <- with(chemtable, filter_RT == "OK" & filter_match =="OK" & 
                                 #(filter_freq.agg == "OK" | filter_freq.ten == "OK" | filter_freq.D == "OK" | filter_freq.N == "OK") &
                                 (filter_freq.agg.N == "OK" | filter_freq.ten.N == "OK" | filter_freq.agg.D == "OK" | filter_freq.ten.D == "OK") &
                                 filter_area == "OK" & filter_ambient_ratio == "OK" & filter_ambient_ttest == "OK" & filter_contaminant == "OK")

plot_filters(chemtable, option="rarity")
plot_filters(chemtable, option="ambient")
plot_filters(chemtable, option="volcano")
plot_filters(chemtable, option="prop")

vol.qual <- prune_sampletable(sampletable, chemtable, metadata)
files_exclude <- c("NEXP1_agg6n3_N_220725_8152022_10.qgd") # flower fell off
vol.qual <- vol.qual[!(rownames(vol.qual) %in% files_exclude) ,]
meta <- metadata[metadata$type == "floral" & !(metadata$sample %in% files_exclude),] %>% droplevels()
vol.qual <- vol.qual / (as.numeric(meta$equil + meta$pumping)/3600) / meta$flrs #0.5 hr of equilibration plus 0.25 hr pumping, one flower
```

# Quantitative integrations

```{r quant}
#read in the large 2022 quant integration output and cut it down to NEXP chromatograms
# source("read_shimadzu.R")
# quantpath <- "~/MyDocs/MEGA/UCI/Schiedea/Analysis/scent/rmbl/RMBL Batches/quant_round3/"
# bfiles <-  list.files(quantpath)
# quant.full <- map_dfr(set_names(paste0(quantpath, bfiles), bfiles), read.shimadzu.quant, .id="batch") %>%
#   mutate(Name = trimws(Name), Area=replace_na(Area, 0)) %>%
#   distinct(Filename, Name, .keep_all=T)
# quant.full %>% select(batch, Dirname, Filename, Name, Area) %>% 
#   mutate(Dirname = fct_relabel(Dirname, str_remove, "C:/GCMSsolution/Data/Project1_190815/")) %>% 
#   filter(Name != "1,6,10-Dodecatrien-3-ol, 3,7,11-trimethyl-") %>% 
#   mutate(Name = recode(Name, !!!shortnames)) %>% 
#   filter(str_detect(Filename, "^NEXP")) %>% select(-Dirname, -batch) %>%
#   pivot_wider(names_from="Name", values_from="Area") %>%
#   write_tsv("data/quant_2022.tsv")

vol <- read_tsv("data/quant_2022.tsv") %>%  
  left_join(select(exp1.verdicts, Filename = FileName, sample2)) %>% drop_na(sample2) %>% 
  select(-Filename) %>% rename(Filename = sample2) %>%  #replace FileName with the sample2 it holds (accounts for skips)
  column_to_rownames("Filename")
contams <- c("methyl salicylate", "benzaldehyde","trans-Geranylgeraniol","Decanal", "D-limonene", "Nonanoic acid", "caprolactam",
             "(2E)-2,7-dimethylocta-2,6-dien-1-ol", #same peak as b-myrcene
             "3-methylbutanal oxime")#passed bouquet in OTC experiment but rare here
vol <- vol[rownames(vol.qual), !colnames(vol) %in% contams]
vol <- vol / (as.numeric(meta$equil + meta$pumping)/3600) / meta$flrs #0.5 hr of equilibration plus 0.25 hr pumping, one flower

(added_quant <- setdiff(colnames(vol), colnames(vol.qual)))#in quant (from temp experiment) but do not pass filters in this dataset
(new_quant <- colnames(vol)[28:33]) #newly integrated, pass filters
(need_quant <- setdiff(colnames(vol.qual), colnames(vol))) # filtered volatiles that need quant integration. 
#vol <- bind_cols(vol, vol.qual[,need_quant]) #temporary, add a couple volatiles that don't have quant integrations yet (currently not on same scale!)
```

#Find chromatograms that have a diverse set of volatiles needed 
  #for new quant integrations (don't need)
```{r diverse, eval=FALSE}
#best <- list()
#i <- 1
#vol.left <- vol.qual[,need_quant]^(1/4) # halfway between areas and presence-absence
#while(ncol(vol.left)>0) {
#  print(dim(vol.left))
#  best[[i]] <- which.max(rowSums(vol.left))
#  vol.left <- vol.left[ , !decostand(vol.left[best[[i]],], method="pa"), drop=FALSE]
#  i <- i+1
#}
#(best.vol <- as.data.frame(t(vol.qual[unlist(best),need_quant])) %>% rownames_to_column("name"))
#chemtable %>% filter(name %in% need_quant) %>% select(name, RT, RT.var) %>% arrange(RT)
```

#To find chromatogram with most diverse set compounds (for quantitative integrations)

```{r diverse, eval=FALSE}
#optional - look for a set of chromatograms that have all of the volatiles needed to set up Shimadzu quantitative integrations
best <- list()
i <- 1
vol.left <- vol.qual[,need_quant]^(1/4) # halfway between areas and presence-absence
while(ncol(vol.left)>0) {
  print(dim(vol.left))
  best[[i]] <- which.max(rowSums(vol.left))
  vol.left <- vol.left[ , !decostand(vol.left[best[[i]],], method="pa"), drop=FALSE]
  i <- i+1
}
(best.vol <- as.data.frame(t(vol.qual[unlist(best),need_quant])) %>% rownames_to_column("name"))
chemtable %>% filter(name %in% need_quant) %>% select(name, RT, RT.var) %>% arrange(RT)
```

# Retention times
## The puzzel - the 4 peaks we are not sure about compound identifications
### prints out graphs

```{r retention, fig.width=12}
longdata.RT <- longdata %>% filter(name %in% c(colnames(vol.qual), colnames(vol))) %>% 
  group_by(name) %>%  mutate(n=n(), RT.sd=sd(RT)) %>% ungroup() %>% 
  mutate(name=fct_reorder(name, RT))

RT.tol <- 0.17  # 10 seconds before or after in quantitative params
ggplot(longdata.RT, aes(x=RT, y=name,color=RT.sd)) + geom_jitter(width=0, height=0.4, size=1) + 
  scale_color_viridis_c(option="magma") + geom_text(aes(x=4.5, label=n)) +
  stat_summary(fun="median", fun.max=~median(.x)+RT.tol, fun.min=~median(.x)-RT.tol, geom="pointrange", color="magenta", size=0.5, shape=15)

#TODO delete (2E)-2,7-dimethylocta-2,6-dien-1-ol (same peak as b-myrcene) from quant integrations
#TODO the following compounds have multiple, overlapping RTs
mess <- c("p-mentha-1,3,8-triene", "carveol", "cosmene", "4,7-Methano-1H-indene, 2,4,5,6,7,7a-hexahydro-")
longdata.RT.mess <- longdata.RT %>% filter(name %in% mess) %>% 
  arrange(RT) %>% mutate(cluster = kmeans(RT, 4, nstart=4)$cluster) %>% 
  group_by(cluster) %>% mutate(RT.cluster = round(mean(RT),2)) %>% ungroup()
ggplot(longdata.RT.mess, aes(x=factor(RT.cluster), fill=name)) + geom_bar()
ggplot(longdata.RT.mess, aes(x=RT, color=name, fill=name)) + facet_wrap(vars(RT.cluster), scales="free_x") + theme_minimal() +
  geom_density(alpha=0.2, linewidth=2) + geom_jitter(aes(y=-as.integer(factor(name))*10), width=0.0002, height=4)

mess.wide <- longdata.RT.mess %>% select(sample, RT.cluster, area) %>% pivot_wider(names_from = RT.cluster, values_from=area, values_fn=sum, values_fill=0)
```


# Heatmap

```{r heatmap, dev='png', dev.args=list()}
library(pheatmap)
library(dendsort)
library(viridis)
ph  <- pheatmap(as.matrix(t(vol))^(1/4), 
         cluster_cols=T, show_colnames=F,
         clustering_method="mcquitty", clustering_distance_rows="correlation",
         clustering_distance_cols=vegdist(vol, method = "bray"),
         clustering_callback = function(hc, ...){dendsort(hc, type="average")},
         scale="none", color=magma(512),
         annotation_col = data.frame(meta %>% select("species","treatment","time"), row.names=rownames(vol)),
         annotation_row = data.frame(added = as.integer(colnames(vol) %in% added_quant), 
                                     new = as.integer(colnames(vol) %in% new_quant),
                                     row.names=colnames(vol)),
   fontsize = 10, border_color = NA, legend=F, annotation_legend=T, cutree_rows=6
)
```

# Ordination

```{r cap}
(cap_treat <- vegan::capscale(sqrt(vol) ~ species + time + treatment, data=meta))
anova.cca(cap_treat, by="margin") # samples should be averaged by plant first

plot(cap_treat, type="n")
points(cap_treat, display="sites", 
       pch=c(1,19)[as.integer(meta$time)],
       col=c("darkred","magenta")[as.integer(meta$species)])
legend("topleft", levels(meta$species), title="Species", fill=c("darkred","magenta"))
legend("topright", levels(meta$time), title="Time", pch=c(1,19))
text(cap_treat, display="species", cex=0.5, col=3)
text(cap_treat, display="cn", cex=0.5)
kable(arrange(as.data.frame(cap_treat$CCA$v), CAP1)) 

```

#Average volatiles

```{r}
#make average volailte table: 
noaverage <- bind_cols(meta,vol)%>%   #want to make table with metadata and volatile list that is not averaged to run Anova on
  group_by(time, treatment, species)%>%
  mutate(timetreatment=paste0(time,treatment)) #paste0 because glht doesn't like spaces in data sets

averagePlant<-bind_cols(meta,vol) %>% group_by(plantid, time, treatment, species) %>% 
  summarize(across(where(is.numeric),mean))       #takes average of each sample for day                                                                                             and night

averagetable<- averagePlant[,12:ncol(averagePlant)] #seperates table into meta data and volatile list table (not necesaary)
averagemetadata<- averagePlant[,1:12]

#cap species * treatment * time p=0.001
AverageVOCcapS.T.T <- capscale(sqrt(averagetable) ~ species * treatment * time, data = averagemetadata, distance = "bray")

anova(AverageVOCcapS.T.T)

#cap Treatment*Time p=0.001
AverageVOCcapT.T <- capscale(sqrt(averagetable) ~ treatment * time, data = averagemetadata, distance = "bray")

anova(AverageVOCcapT.T)

#cap Treatment p=0.143
AverageVOCcapTreatment <- capscale(sqrt(averagetable) ~ treatment, data = averagemetadata, distance = "bray")

anova(AverageVOCcapTreatment)

#cap Time p=0.001***
AverageVOCcapTime <- capscale(sqrt(averagetable) ~ time, data = averagemetadata, distance = "bray")

anova(AverageVOCcapTime)
```

# Indole 

```{r}
#make average tenuituba table
averageTENmetadata<- averagemetadata[averagemetadata$species=="ten",]
averageTENtable<-averagetable[averagemetadata$species=="ten",]
averageTEN <- bind_cols(averageTENmetadata, averageTENtable) %>%  #combines averaged meta data table and average volatile                                                                           list table together
  mutate(timetreatment=paste(time,treatment))           #want to combine time and treatment into the same colum bc glht                                                                   needs that
#only ten indole boxplot
ggplot(averageTEN, aes(color=treatment, x=time, y=indole))+geom_boxplot()+scale_y_sqrt() #box plot for TEN indole 

# agg and ten indole boxplot
facet.labs <- c(agg="I. aggregata", ten="I. tenuituba")

plot.indole.aggten=
  ggplot(averagePlant, aes(color=treatment, x=time,y=indole))+
  #geom_boxplot(position=position_dodge(width=0.9))+
  #geom_point (position=position_dodge(width=0.9))+
  geom_boxplot()+
  scale_y_sqrt()+
  ylab("Indole Emissions")+
  #ylim(0,25000) + #scales y-axis 
  facet_wrap(vars(species))+ #makes two columns for species
    facet_grid(. ~ species, labeller=labeller(species = facet.labs))+ 
    theme(panel.border = element_blank(),
      panel.grid.major = element_line(colour="white"),
      #panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "gray96",
                                #colour = "lightblue",
                                  linetype = "solid"),
      strip.text.x = element_text(size=11),
      strip.background = element_rect(colour="white", fill="white"))+
    scale_color_manual(name="Nitrogen Level", 
        labels= c("High",  "Low"), 
        values=c("tan2","cadetblue3"))+
    theme(legend.title = element_text(size=11, color = "black"),
        legend.text=element_text(size=9))
print(plot.indole.aggten)    
ggsave(plot.indole.aggten, file='Indole_boxplot.jpg', width=150, height=110, units= 'mm', dpi=300)

library(car)
library(lmerTest)
library(lme4)

#Only indole lmer with plantid as random effect

noaverage$S.T.T <- factor(paste0(noaverage$species, noaverage$time, noaverage$treatment))
(indolelmer<-lmer(sqrt(indole)~S.T.T + (1|plantid), data=noaverage)) #use not averaged data! d
summary(multcomp::glht(indolelmer, linfct= multcomp::mcp(S.T.T = c("aggDhigh-aggDlow == 0","aggNhigh - aggNlow == 0", "tenNhigh - tenNlow == 0", "tenDhigh-tenDlow==0"))))

```

```{r}
#SD - because indole model above not working, says SD=0 but not true
#noaverage%>% group_by(plantid,S.T.T) %>% 
  #summarise(SD=sd(indole), mean=mean(indole))
```

#compound changes (see below -> individual compound changes)

```{r}

#library(lme4)
#library(lmerTest)
#library(broom.mixed)
#library(dplyr)


#compoundmodels <- bind_cols(vol, meta) %>% 
#  pivot_longer(all_of(colnames(vol)), names_to="chem", values_to="amount")%>% # move volatiles into column
#  group_by(species, time, chem) %>%  #tells nest what to nest by species, time and chemical name
#    nest() %>% 
#    mutate(model=map(data, ~lmer(sqrt(amount)~ treatment + (1|plantid), data=.x)),
#           test=map(model, ~ tidy(anova(.x)))) #anova on each compound in each subset of species and time, stores in                                                                    column test
#compoundtests <- compoundmodels %>% dplyr::select(test) %>% 
#  unnest(test) %>% mutate(p.adjusted= p.adjust(p.value, method = "bonferroni", n=108)) #read wiki page on false discovery

#how much of a difference the treatment made
#compoundchanges <- compoundmodels %>% mutate(coef= map(model, ~tidy(.x))) %>% 
#  dplyr::select(coef) %>% unnest(coef) %>%
#  summarise(nitrogeneffect= estimate[1]/(estimate[1]+estimate[2]), p.value=p.value[2])  #nitrogeneffect = change of compound (i.e. X compound increased 3.2 fold in high nitrogen treatment
# for nitrogeneffect subtract by 1 to get the % change
```


# I. tenuituba Day Volatiles

```{r}
 
TENdaytable<-averageTENtable[averageTENmetadata$time=="D",]
TENdaymetadata<-averageTENmetadata[averageTENmetadata$time=="D",]

TENcapday <- capscale(sqrt(TENdaytable) ~ treatment , data = TENdaymetadata, distance = "bray")

anova(TENcapday, by="term")
#p=0.86

```

# I. tenuituba Night Volatiles

```{r}
TENnighttable<-averageTENtable[averageTENmetadata$time=="N",]
TENnightmetadata<-averageTENmetadata[averageTENmetadata$time=="N",]

TENcapnight <- capscale(sqrt(TENnighttable) ~  treatment, data = TENnightmetadata, distance = "bray")

anova(TENcapnight, by="term")
#p=0.229
```


# I. aggregata Daytime Volatiles

```{r}
averageaggmetadata<- averagemetadata[averagemetadata$species=="agg"& averagemetadata$time=="D",]
averageaggtable<-averagetable[averagemetadata$species=="agg"& averagemetadata$time=="D",]

agg.day.cap <- capscale(sqrt(averageaggtable) ~ treatment, data = averageaggmetadata, distance = "bray")

#To get % explained (= eigenvalues) for each cap axis
eig <-eigenvals(agg.day.cap)
axis.eig <- eig/ sum(eig)
print(axis.eig)

#remotes::install_github("gavinsimpson/ggvegan")
library(ggvegan)
library(dplyr)

cap.dataframe <- fortify(agg.day.cap) #turns cap into data frame so you can run it in ggplot
#autoplot(agg.day.cap) #plots cap


##generate a plot in ggplot
agg.Day.ordination = ggplot(bind_cols(filter(cap.dataframe, Score=="sites"),averageaggmetadata), aes(x=CAP1, y= MDS1, color = treatment)) + 
  geom_point(size=2.6) +
  theme_classic() + 
  coord_fixed(xlim=c(-1.5, 2.9), ylim=c(-1, 2.4)) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  labs(color = "Treatment", fill = "Treatment") +
 # ggtitle("I. aggregata Daytime Volatiles") +
  theme(plot.title = element_text(hjust = 0.5))+
  ylab("MDS1 (33.2% explained)") + 
  xlab("CAP1 (12.5% explained)") + 
  scale_color_manual(name="Nitrogen Level", labels= c("High", "Low"), values=c("tan2","cadetblue3")) +
  labs(subtitle="ANOVA; p=0.021",hjust = 1)+ #adds subtitle at top of figure
   theme(legend.title = element_text(size=12, color = "black"), legend.text=element_text(size=10),
           legend.justification=c(0,1), 
           legend.position=c(0.03, 0.95),
           legend.background = element_blank(),
           legend.key = element_blank(),
            plot.subtitle = element_text(hjust = 1)) #moves subtitle to right side 
  
    
print(agg.Day.ordination)
ggsave(agg.Day.ordination, file='agg_Day_ordinationplot.jpg', width=130, height=105, units= 'mm', dpi=300)

###################################################

#Compound names on ordination plot
library(ggrepel) #makes it so labels don't overlap

ggplot(filter(cap.dataframe, Score=="species", sqrt(CAP1^2+MDS1^2)>0.2), aes(x=CAP1, y= MDS1)) + 
  geom_point()+
  geom_text_repel(aes(label=Label)) +
  theme_classic() + 
  coord_fixed(xlim=c(-1.25, 1), ylim=c(-1.5, 0.4)) +#coord fixed evenly scales x&y
  geom_hline(yintercept = 0, linetype="dotted") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  labs(color = "Treatment", fill = "Treatment") +
 # ggtitle("I. aggregata Daytime Volatiles") +
  theme(plot.title = element_text(hjust = 0.5))+
  ylab("MDS1") + 
  xlab("CAP1") 

#text(cap, display = "species", col="grey50")
#text(cap, display = "cn", labels= c("Day","Night","High Nitrogen","Low Nitrogen"), col="gray")
########################################################

anova(agg.day.cap, by="term")
#p=0.021

```

# I. agg Night time volatiles (average)
```{r}
averageaggmetadataNIGHT<- averagemetadata[averagemetadata$species=="agg"& averagemetadata$time=="N",]
averageaggtableNIGHT<-averagetable[averagemetadata$species=="agg"& averagemetadata$time=="N",]

agg.night.cap <- capscale(sqrt(averageaggtableNIGHT) ~ treatment, data = averageaggmetadataNIGHT, distance = "bray")

#eig <-eigenvals(agg.day.cap)
#axis.eig <- eig/ sum(eig)
anova(agg.night.cap, by="term")

#p=0.593
```


# Total emissions 

```{r}
averageaggmetadata$totalemssions <-rowSums(averageaggtable) #sums rows of volatiles to get total emissions (via adding all peak areas) for each sample

meta$totalemission <- rowSums(vol)  #attatches row sums to metadata 

total.emission.model <-lmer(totalemission~treatment*species*time + (1|plantid), data=meta) #models looks at total emissions as a function of treatment*species*time with plantid as a random effect
Anova(total.emission.model, type=3) #type 3 anova on the model to get p-value

##############################################
#boxplot of Total emissions for Agg and Ten day & night

facet.labs <- c(agg="I. aggregata", ten="I. tenuituba")

plot.total.emissions=
  ggplot(meta, aes( y= totalemission, x=time, #could do with average metadata instead of all data points in meta
  color=treatment))+
  geom_boxplot(position=position_dodge(width=0.9))+
  geom_point (position=position_dodge(width=0.9))+ #makes it so point don't overlap
  scale_y_sqrt()+
  ylab("Total Emissions")+
  xlab("") +
  facet_wrap(vars(species)) +
    facet_grid(. ~ species, labeller=labeller(species = facet.labs))+ 
    theme(panel.border = element_blank(),
      panel.grid.major = element_line(colour="white"),
      #panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "gray96",
                                #colour = "lightblue",
                                  linetype = "solid"),
      strip.text.x = element_text(size=11),
      strip.background = element_rect(colour="white", fill="white"))+
    scale_color_manual(name="Nitrogen Level", 
        labels= c("High",  "Low"), 
        values=c("tan2","cadetblue3"))+
    theme(legend.title = element_text(size=11, color = "black"),
        legend.text=element_text(size=9))+
  scale_x_discrete(labels=c('Day', 'Night', 'Day','Night'))

print(plot.total.emissions)   
#ggsave(plot.total.emissions, file='total_emissions_boxplot.jpg', width=150, height=110, units= 'mm', dpi=300)

#######################################
meta$S.T.T <- paste0(meta$species, meta$time, meta$treatment) #add column with species, treatment and time to metadata. Need for glht

#finding p-values to compare treatment within each of the four groups
total.emission.model2 <-lmer(totalemission~S.T.T + (1|plantid), data=meta)

Anova(total.emission.model2, type=3)

library(multcomp)

#general linear hypotheses
  #subtracts means from different groups (like Agg day low - agg day high) c
      #can specify which group like below or write linfct=mcp(model ="Tukey"))
  # summary () gives you p-values
summary(glht(total.emission.model2, linfct=mcp(S.T.T= 
                                           c("aggDlow - aggDhigh == 0",
                                             "aggNlow-aggNhigh==0", 
                                             "tenDlow-tenDhigh==0",
                                             "tenNlow-tenNhigh==0"))),                                                               test=adjusted(type="none"))

#total emissions change at night time between high and low in agg p=0.0349
  
```

# Individual compound change for treatment based on species and time

```{r}
dominantvocs <-averagePlant%>% pivot_longer(any_of(colnames(vol)))%>%     group_by(species,time,treatment,name)%>% 
   summarise(value=mean(value))%>%
   # mutate(value=value/sum(value))%>% #adds up values for each treatment
  arrange(species, time, treatment, desc(value))

ggplot(dominantvocs, aes(y=fct_reorder(name, value), x=value, color=treatment, shape=time))+
         geom_point()+
    scale_x_sqrt()+ #scales x axis so you can see small peak area dots
    facet_wrap(vars(species))+ #makes two pannels, agg and ten
    scale_color_manual(values=c("orange","lightblue"))+ #manually change colros
    theme_minimal() #removed grey from background
    

```

#anova on specific/individual compounds 

```{r}
library(broom.mixed)
library(dplyr)
library(lme4)

individualcompoundpvalue <- bind_cols(meta, vol) %>% 
  pivot_longer(all_of(colnames(vol))) %>%
  group_by(species,time, name)%>%
  nest() %>% mutate(model=map(data, ~lmer(value~ treatment + (1|plantid), data=.x))) %>%  

# mutate adds column, we are adding model column; map runs a for loop through data column  only once; value = emission rate in ng/hr; ~ says run this function; .x is empty data frame model stores values in
  
  mutate(test=map(model, ~tidy(anova(.x)))) %>% 
  dplyr::select(test) %>%   #select(test) makes unnesting happier
  unnest()%>% ungroup()%>%                         
  mutate(p.adjusted=p.adjust(p.value, method="fdr")) #p.adjust adjusts p-value

#View(individualcompoundpvalue)

```

# Relative Amount

```{r}
library(vegan)
library(dplyr)

# Total relative amount divide by margin total 
relativeamount.vol <- decostand(vol, "total")

relativeamount <- bind_cols(meta, relativeamount.vol) %>% 
   pivot_longer(all_of(colnames(vol))) %>% 
  group_by(species,time, name)%>% 
   dplyr::select(species, time, treatment, plantid, name, value)  

#View(relativeamount)

# Relative amount presents/ absents 0s & 1s 
relativeamountPA <- decostand(vol, "pa")

#View(relativeamountPA)

#cap on relative amount (with Square root transform) 
rel.amount.cap <- capscale(sqrt(relativeamount.vol) ~ treatment, data = meta, distance = "bray")

rel.amount.dataframe <- fortify(rel.amount.cap)
rel.amount.ordination = ggplot(bind_cols(filter(rel.amount.dataframe, Score=="sites"),meta), aes(x=CAP1, y= MDS1, color = treatment)) + 
  geom_point(size=2.6) +
  theme_classic() + 
  coord_fixed(xlim=c(-1.5, 2.9), ylim=c(-1, 2.4)) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  labs(color = "Treatment", fill = "Treatment") +
 # ggtitle("I. aggregata Daytime Volatiles") +
  theme(plot.title = element_text(hjust = 0.5))+
  ylab("MDS1 (% explained)") + 
  xlab("CAP1 (% explained)") + 
  scale_color_manual(name="Nitrogen Level", labels= c("High", "Low"), values=c("tan2","cadetblue3")) +
  labs(subtitle="ANOVA; p=0.264",hjust = 1)+ #adds subtitle at top of figure
   theme(legend.title = element_text(size=12, color = "black"), legend.text=element_text(size=10),
           legend.justification=c(0,1), 
           legend.position=c(0.03, 0.95),
           legend.background = element_blank(),
           legend.key = element_blank(),
            plot.subtitle = element_text(hjust = 1)) #moves subtitle to right side 
  
    
print(rel.amount.ordination)

anova(rel.amount.cap, by="term")
#p= 0.264

```

#per flower emission 
```{r}
# left_join( emission per sample and total flower number

```

