---
title: "Ipomopsis nitrogen experiment 1 volatiles"
author: "Janelle Bohey, John Powers"
date: "`r Sys.Date()`"
output: 
  html_document:
    self_contained: no
    lib_dir: libs
    code_folding: hide
    toc: yes
    toc_float: TRUE 
editor_options: 
  chunk_output_type: console
---
<style type="text/css">
.main-container { max-width: 1000px; margin-left: 0; margin-right: auto; }
img{ max-width:200%; height: auto; }
td, th { padding : 6px }
</style>

This has correct quant integrations and full compound list
Speciestime & treatment grouping instead of species, time, treatment
34 compounds with quantitative integrations

=======

```{r setup, include=FALSE}
library(reshape2)
library(tidyverse)
library(lubridate)
library(vegan)
library(knitr)
#install.packages("remotes")
#remotes::install_github("jmpowers/bouquet", build_vignettes = TRUE)
library(bouquet)
knitr::opts_chunk$set(comment="", cache=T, warning=F, message=F, 
                      fig.path = "plots-nitrogen/", dev="svglite", dev.args=list(fix_text_size=FALSE), fig.height=8, fig.width=10)
#remotes::install_github("gavinsimpson/ggvegan")
library(ggvegan)
library(dplyr)
```

#data visualization
```{r,data visualization set up}
#set standard figure dimensions
opts_chunk$set(fig.height=8, fig.width=8, dpi=100, fig.path="figures/") #sets standard width and height for all figures in rmd; creates folder only when rmd is knitted
#can also change height in {} at the top of the chunk

#set figure theme
NEXP1.theme <- theme(
      #axis text
                  axis.title = element_text(size=13),     #x axis title text size
                  axis.text.x = element_text(size=12, color = "black"),     #x axis labels text size
                  axis.ticks.x = element_blank(),  # Remove tick marks on x-axis
                  axis.title.x = element_text(margin = margin(t = 10)),  # Adds 10 units of space on top of the x-axis title
                  axis.text.y = element_text(size = 12),
                  axis.title.y = element_text(margin = margin(r = 15)),  # Adds 15 units of space to the right of the y-axis title
      #legend
                  legend.text = element_text(size=11),       #legend text size
                  legend.title = element_text(size=12, color = "black", hjust = 0.5),  #legend title text size
                  legend.position = "right",                #"left", "right", "bottom", "top", or a coordinate
                  legend.direction = "vertical",           #layout direction of the legend ("horizontal" or "vertical")
                  legend.spacing = unit(1, "cm"),            #spacing between legend items; adds 1cm of space between
                  legend.key.size = unit(1.1, "cm"),         #size of the legend keys (symbols); sets legend key to 1.5cm
      #panels
                  panel.border = element_blank(),            # border around the plot area
                  panel.grid.major = element_line(colour="white"),
                  #panel.grid.minor = element_blank(),
                  panel.background = element_rect(fill = "white", # # Remove grey background (set to white)
                                          #colour = "lightblue",
                                          linetype = "solid"),
      
      #facets
                  strip.text.x = element_text(size=14),       #strip text on x-axis facet
                  strip.background = element_rect(colour="white", fill="white")) #background for the strip label
                  #strip.text = element_text(size = 20) )   #This changes the size of the facet labels

#TODO: when I change the strip.text (aka facet text) font, nothing happens...

field.label.colors.theme <- scale_color_manual(name="Nitrogen Level", 
          labels= c(control="No water added", nitrogen= "High nitrogen", watercontrol= "Low nitrogen"), 
          values=c(control="#8b9b31",nitrogen="#b35f98", watercontrol="#3a8db3"))

greenhouse.label.colors.theme <- scale_color_manual(name="Nitrogen Level", 
          labels= c( high= "High nitrogen", low= "Low nitrogen"), 
          values=c(high="#b35f98", low="#3a8db3"))

#color scheme
#scale_color_manual(name="Nitrogen Level", 
#        labels= c("no water added",  "high nitrogen", "low nitrogen"), #Specifies treatment names in legend
#        values=c("#8b9b31", "#b35f98", "#3a8db3")
  

#ggplot boxplot code: 
#plot.total.emissions.field=
#  ggplot(meta.field, aes( y= totalemission, x=time, color=treatment))+
#  geom_boxplot(position=position_dodge(width=0.9))+
#  geom_point (position=position_dodge(width=0.9))+ #makes it so point don't overlap
#  scale_y_sqrt()+
#  ylab("Total Emissions")+
#  xlab("") +
#  facet_wrap(vars(species)) +
#  facet_grid(. ~ species, labeller=labeller(species = facet.labs))+ 
#  scale_x_discrete(labels=c('Day', 'Night', 'Day','Night'))+ #x axis text
#  ylim(0.1, 0.56)+  # Set y-axis limits from 0.1 to 0.56 + 
#  NEXP1.theme +
#  scale_color_manual(name="Nitrogen Level", 
#        labels= c("no water added",  "high nitrogen", "low nitrogen"), #Specifies treatment names in legend
#        values=c("#8b9b31", "#b35f98", "#3a8db3")


#print(plot.total.emissions.field)  

#ggplot ordination code: 
#agg.Day.ordination = ggplot(bind_cols(filter(cap.dataframe, score=="sites"),averageaggmetadata), aes(x=CAP1, y= MDS1, color = treatment)) + 
#  geom_point(size=2.6) +
#  theme_classic() + 
#  coord_fixed(xlim=c(-1.5, 2.9), ylim=c(-1, 2.4)) +
#  geom_hline(yintercept = 0, linetype="dotted") + 
#  geom_vline(xintercept = 0, linetype="dotted") +
#  labs(color = "Treatment", fill = "Treatment") +
 # ggtitle("I. aggregata Daytime Volatiles") +
#  theme(plot.title = element_text(hjust = 0.5))+
#  ylab("MDS1 (33.2% explained)") + 
#  xlab("CAP1 (12.5% explained)") + 
#  scale_color_manual(name="Nitrogen Level", labels= c("High", "Low"), values=c("orange","skyblue")) +
#  labs(subtitle="ANOVA; p=0.031",hjust = 1)+ #adds subtitle at top of figure
#   theme(legend.title = element_text(size=12, color = "black"), legend.text=element_text(size=10),
#           legend.justification=c(0,1), 
#           legend.position=c(0.03, 0.95),
#           legend.background = element_blank(),
#           legend.key = element_blank(),
#            plot.subtitle = element_text(hjust = 1)) #moves subtitle to right side 
  
#print(agg.Day.ordination)
```



#setup
```{r read_scents}
setwd("~/Desktop/ipomopsis-nitrogen") #set working directory
library(googlesheets4) #need for read_sheets 
exp1_meta <- read_sheet("1k2XJUsRyTsQEeEoZE24yTvsl7kSyf2Gg6gehs8pUvOo", sheet="metadata", guess_max=200) %>% #sheet selects "metadata" sheet on Google Sheets, guess_max reads 200 lines before program guesses the type of each column (string vs integer vs date)
  mutate(plant = as.character(plant))

exp2leaf_meta <- read_sheet("1EwPMsBAxqrRtuqH4uUBtthUOZlQluQICSvNr9u87h0E", sheet="metadata", guess_max=200) %>%
  mutate(plant = as.character(plant))

exp1_field_nofilename <- read_csv("data/2022 Poverty Gulch Volatiles.csv") %>%
  mutate(plant = as.character(plant),
         Sample=paste0(plant, ifelse(is.na(replicate),"", replicate)), 
         type= factor(ifelse(str_detect(Sample, "AIR"), "ambient", "floral")), date=ymd(date),
         treatment=fct_recode(replace_na(treatment, "air"),control="ambient", watercontrol ="water control"),
         equil=pump-bag, pumping=end-pump) 

exp1_field_link <-read_csv("data/AA_samples6.csv") %>%   #links filename and metadata
  mutate(date=ymd(date)) #these FileNames have already been corrected for skips

exp1_field_meta <- left_join(exp1_field_link, exp1_field_nofilename)

#trying to figure out mismatch in filemane and metadata bc there are NAs
filter(exp1_field_meta, is.na(type)) %>% pull(Filename)
# filters to list only filenames with NAs
filter(exp1_field_link, !Filename %in% exp1_field_meta$Filename) %>% pull(Filename)

#setdiff finds differences in dataframes to identify missing samples
setdiff(exp1_field_link$Filename, drop_na(exp1_field_meta, type)$Filename) 
#setdiff shows the difference between links and meta, 
#trying to find if there are filenames and metadata that don't match up but we didn't find any
setdiff(drop_na(exp1_field_meta, type)$Filename, exp1_field_link$Filename)

#dropping filenames with no metadata; remove later
exp1_field_meta <- drop_na(exp1_field_meta, type)

gc_verdicts <- read_sheet("1X8oo7qZlo1p6MVl_CBeBe6CUTHEAcd-FWQzfHud3Qws", sheet = "gc2022") %>% #verdicts = the truth of the skips, renames all skips in R 
  mutate(sample2 = ifelse(is.na(sample), FileName, sample))

#verdicts 
exp1_verdicts <- gc_verdicts %>% filter(sample2 %in% exp1_meta$filename) #sample2= if sample is blank on metadata then its the filename no renaming necessary but if sample has a filename then something before it skipped and your re lining up/ accounting for skip (translating between the filename you want and the filename you have) 

exp2leaf_verdicts <- gc_verdicts %>% filter(sample2 %in% exp2leaf_meta$filename)

#New meta matching file name in meta with sample file name on GC

exp1_field_verdicts <- gc_verdicts %>% filter(FileName %in% exp1_field_meta$Filename)

#exp1_field_verd_merged <- left_join(exp1_field_verdicts, exp1_field_meta)#merge by FileName 

write_csv(exp1_verdicts, file = "data/exp1_verdicts.csv")
write_csv(exp2leaf_verdicts, file = "data/exp2leaf_verdicts.csv")
write_csv(exp1_field_verdicts, file = "data/exp1_field_verdicts.csv")

load("data/shimadzu_data_22.rda") #loading qualitative integrations all of them from 2022

#exp1.data = greenhouse N experiment data only
#pg.data= field N experiment at Poverty Gulch data only 

exp1.data <- shimadzu.data.22 %>% filter(Filename %in% exp1_verdicts$FileName) #
#exp2leaf.data <- shimadzu.data.22 %>% filter(Filename %in% exp2_verdicts$FileName)
exp1.field.data <- shimadzu.data.22 %>% filter(Filename %in% exp1_field_verdicts$FileName)
save(exp1.data, file = "data/exp1_data.rda")
#save(exp2leaf.data, file = "data/exp2leaf_data.rda")
save(exp1.field.data, file = "data/exp1_field_data.rda")

exp1.verdicts <- read_csv("data/exp1_verdicts.csv")
load("data/exp1_data.rda") #loads exp1.data (Shimadzu output)

exp1.data <- exp1.data %>% left_join(select(exp1.verdicts, Filename = FileName, sample2)) %>% 
  select(-Filename) %>% rename(Filename = sample2) %>%  #replace FileName with the sample2 it holds (accounts for skips)
  droplevels()

exp1.field.verdicts <- read_csv("data/exp1_field_verdicts.csv")
load("data/exp1_field_data.rda") #loads exp1.field.data (Shimadzu output)

exp1.field.data <- exp1.field.data %>% left_join(select(exp1.field.verdicts, Filename = FileName, sample2)) %>% 
  select(-Filename) %>% rename(Filename = sample2) %>%  #replace FileName with the sample2 it holds (accounts for skips)
  droplevels()

# load short names
ipochems <- read_csv("data/Ipo volatile compounds - chemsf_ipo.csv") %>% 
  select(name, shortname, standard, verdict) %>%  filter(verdict != "")
            
#shorten chemical names and merge compounds with multiple names
shortnames <- ipochems %>% select(name, shortname) %>% filter(shortname!="") %>% deframe()

exp1.data$Name <- dplyr::recode(exp1.data$Name, !!!shortnames)
exp1.field.data$Name <- dplyr::recode(exp1.field.data$Name, !!!shortnames)

exp1.all <- dcast(exp1.data, Filename~Name, sum, value.var="Area") #all means all VOCs unfiltered
rownames(exp1.all) <- exp1.all[,1]
exp1.all[,1] <- NULL

exp1.field.all <- dcast(exp1.field.data, Filename~Name, sum, value.var="Area")
rownames(exp1.field.all) <- exp1.field.all[,1]
exp1.field.all[,1] <- NULL
```

# Read metadata for Weatherport experiment

```{r metadata, fig.height=5, fig.width=5}
metadata <- read_csv("data/EXP 1 (N) Volatile sampling  - metadata.csv") %>% 
  filter(filename != "#N/A") %>% 
  mutate(plantid = paste(species, plant), speciestime = paste(species, time, sep=".")) %>% 
  left_join(read_csv("data/exp1_treatments.csv") %>% mutate(plant = as.character(plant)))
rownames(metadata) <- metadata$filename
metadata <- metadata[rownames(exp1.all),] #order metadata to match order of data (which already. corrected for skips above in exp1.all)

metadata %>% count(species, time, treatment) %>% kable()
metadata %>% filter(species !="AMB") %>% count(species, plantid, time) %>% 
  ggplot(aes(x=n, fill=time))+ geom_histogram(binwidth=1) + facet_wrap(vars(time), ncol=1)+
  labs(x="Samples per plant") 

metadata %>% filter(species !="AMB") %>% group_by(time) %>% 
  mutate(pump.dt = ymd_hms(paste(date, pump)), pump.hr = hour(pump.dt)+minute(pump.dt)/60,
         bag.dt = ymd_hms(paste(date, bag)), bag.hr = hour(bag.dt)+minute(bag.dt)/60,
         end.dt = ymd_hms(paste(date, bag)), end.hr = hour(end.dt)+minute(end.dt)/60) %>% 
  summarize(min=min(bag.hr), max=max(end.hr))  %>% kable(caption="first bag time, last ending time, in hr", digits=2)

ggplot(metadata, aes(y=equil, x=species)) + geom_boxplot() + labs(y="Equilibration duration")
ggplot(metadata, aes(y=pumping, x=species)) + geom_boxplot() + labs(y="Pumping duration")

metadata %>% count(species) %>% kable(caption="total volatile samples by species")

digging_date <- ymd("2022-06-24")
treatment_date <- digging_date + days(6)
ggplot(metadata, aes(x=date-treatment_date, fill=species))+geom_histogram(binwidth=1)
metadata %>% count(date-treatment_date) %>% kable(caption=paste("days since treatments began on", treatment_date))
```


# Read Arturo's field metadata 

```{r metadata.field, fig.height=5, fig.width=5}
metadata.field <- exp1_field_meta %>% #Filename already accounted for skips
  rename(time=d_n, species=site, sample2=Filename) %>% #to do the join
  mutate(plantid = paste(species, plant), 
         speciestime = paste(species, time, sep="."),
         plant = as.character(plant)) %>% 
  mutate(treatmentx2=fct_recode(treatment, control="watercontrol")) %>%  #combine watercontrol and control 
  left_join(exp1.field.verdicts) %>% rename(filename=sample2) %>%
  
  drop_na(filename) %>% #TODO need to rescue some of these rows that might be good?
  mutate(type=replace_na(type,"floral"))
rownames(metadata.field) <- metadata.field$filename #adds row names (makes row name the filename)
metadata.field <- metadata.field[rownames(exp1.field.all),] #order metadata to match order of shimadzu data
MnD <- setdiff(metadata.field$filename, rownames(exp1.field.all)) #dropping differences between metadata.field and exp1.field.all. MnD= in metadata but not in data
DnM <- setdiff(rownames(exp1.field.all), metadata.field$filename) #DnM= in data but not in metadata

metadata.field <- filter(metadata.field, !filename %in% MnD) #drops filenames that are in metadata but not in data
exp1.field.all <- filter(exp1.field.all, !rownames(exp1.field.all) %in% DnM)
exp1.field.data <- filter(exp1.field.data, !exp1.field.data$Filename %in% DnM)

metadata.field %>% count(species, time, treatment) %>% kable() 
metadata.field %>% drop_na(species) %>% count(species, plantid, time) %>% 
  ggplot(aes(x=n, fill=time))+ geom_histogram(binwidth=1) + facet_wrap(vars(time), ncol=1)+
  labs(x="Samples per plant") 
#figure out type==NA

# metadata.field %>% filter(type=="floral") %>% group_by(time) %>% 
#   mutate(pump.dt = ymd_hms(paste(date, pump)), pump.hr = hour(pump.dt)+minute(pump.dt)/60,
#          bag.dt = ymd_hms(paste(date, bag)), bag.hr = hour(bag.dt)+minute(bag.dt)/60,
#          end.dt = ymd_hms(paste(date, bag)), end.hr = hour(end.dt)+minute(end.dt)/60) %>% 
#   summarize(min=min(bag.hr), max=max(end.hr))  %>% kable(caption="first bag time, last ending time, in hr", digits=2)

#ggplot(metadata.field, aes(y=equil, x=species)) + geom_boxplot() + labs(y="Equilibration duration")
#ggplot(metadata.field, aes(y=pumping, x=species)) + geom_boxplot() + labs(y="Pumping duration")

metadata.field %>% count(species) %>% kable(caption="total volatile samples by species")

treatment_date <-  ymd("2022-06-24")#this is not the right date
#start N addition date: june 21st for agg; june 28th for ihyb site
#end date: July 19th for agg; july 26th for ihyb
ggplot(metadata.field, aes(x=date-treatment_date, fill=species))+geom_histogram(binwidth=1)
metadata.field %>% count(date-treatment_date) %>% kable(caption=paste("days since treatments began on", treatment_date))
```


# Filtering Exp1 Greenhouse

```{r filtering}
metadata <- metadata %>% mutate(type= ifelse(species=="AMB", "ambient","floral")) %>% rename(trap=sample) %>% as.data.frame() %>% 
  load_metadata(date = "date", sample = "filename", group = "speciestime", type = "type") #combine species and time (previously separate)
#if issue with "rename" just rerun where you first made metadata

longdata <- load_longdata(exp1.data, sample = "Filename", RT = "Ret.Time", 
                          name = "Name", area = "Area", match = "SI", maxmatch=100)

sampletable <- make_sampletable(longdata, metadata)

chemtable <- make_chemtable(longdata, metadata) %>% 
  filter_RT(2, 17) %>% 
  filter_match(0.8) %>% 
  filter_freq(0.2, group = TRUE) %>% 
  filter_contaminant(cont.list = c("Caprolactam","13-Methyltetradecanal","Cyclohexane, 1,1-dimethyl-2-propyl-","2-hexyldecan-1-ol","Tridecane, 3-methylene-")) %>% 
  filter_area(min_maximum = 1e5) %>%
  filter_ambient_ratio(sampletable, metadata, ratio = 4, group= TRUE) %>% 
  filter_ambient_ttest(sampletable, metadata, 
                       alpha = 0.05, adjust = "fdr") 
chemtable$filter_final <- with(chemtable, filter_RT == "OK" & filter_match =="OK" & 
                                 (  (filter_freq.agg.N == "OK" & ambient_ratio_ten.N>4) | 
                                    (filter_freq.ten.N == "OK" & ambient_ratio_ten.N>4) | 
                                    (filter_freq.agg.D == "OK" & ambient_ratio_agg.D>4) |
                                    (filter_freq.ten.D == "OK" & ambient_ratio_ten.D>4)) &
                                      filter_area == "OK" & filter_contaminant == "OK")

plot_filters(chemtable, option="rarity")
plot_filters(chemtable, option="ambient")
plot_filters(chemtable, option="volcano")
plot_filters(chemtable, option="prop")

vol.qual <- prune_sampletable(sampletable, chemtable, metadata)
files_exclude <- c("NEXP1_agg6n3_N_220725_8152022_10.qgd") # flower fell off
vol.qual <- vol.qual[!(rownames(vol.qual) %in% files_exclude) ,]
meta <- metadata[metadata$type == "floral" & !(metadata$sample %in% files_exclude),] %>% droplevels()
vol.qual <- vol.qual / (as.numeric(meta$equil + meta$pumping)/3600) / meta$flrs #0.5 hr of equilibration plus 0.25 hr pumping, one flower
```

# Filtering Exp1 Field

```{r filtering_field}
#need to get rid of NA values in metadata.field for code below to run
#group= speciestime, should we do the same for arturo's data? need to make new column if yes

metadata.field <- metadata.field %>% as.data.frame() %>% 
  load_metadata(date = "date", sample = "filename", group = "speciestime", type = "type") #combine species and time (previously separate)

longdata.field <- load_longdata(exp1.field.data, sample = "Filename", RT = "Ret.Time", 
                          name = "Name", area = "Area", match = "SI", maxmatch=100) %>% 
  filter(name !="") %>% mutate(name = droplevels(name))

setdiff(as.character(metadata.field$sample), longdata.field$sample)
setdiff(longdata.field$sample, as.character(metadata.field$sample))

sampletable.field <- make_sampletable(longdata.field, metadata.field)

chemtable.field <- make_chemtable(longdata.field, metadata.field) %>% 
  filter_RT(2, 17) %>% 
  filter_match(0.8) %>% 
  filter_freq(0.2, group = TRUE) %>% 
  filter_contaminant(cont.list = c("Caprolactam", "13-Methyltetradecanal","Cyclohexane, 1,1-dimethyl-2-propyl-","2-hexyldecan-1-ol","Tridecane, 3-methylene-")) %>% 
  filter_area(min_maximum = 1e5) %>%
  filter_ambient_ratio(sampletable.field, metadata.field, ratio = 4, group=TRUE) %>% 
  filter_ambient_ttest(sampletable.field, metadata.field, 
                       alpha = 0.05, adjust = "fdr") 
chemtable.field$filter_final <- with(chemtable.field, filter_RT == "OK" & filter_match =="OK" & 
                                 (  (filter_freq.Lagg.N == "OK" & ambient_ratio_Lagg.N>4) | 
                                    (filter_freq.Ihyb.N == "OK" & ambient_ratio_Ihyb.N>4) | 
                                    (filter_freq.Lagg.D == "OK" & ambient_ratio_Lagg.D>4) |
                                    (filter_freq.Ihyb.D == "OK" & ambient_ratio_Ihyb.D>4)) &
                                      filter_area == "OK" & filter_contaminant == "OK")

plot_filters(chemtable.field, option="rarity")
plot_filters(chemtable.field, option="ambient")
plot_filters(chemtable.field, option="volcano")
plot_filters(chemtable.field, option="prop")

vol.qual.field <- prune_sampletable(sampletable.field, chemtable.field, metadata.field)
files_exclude <- c("") 
vol.qual.field <- vol.qual.field[!(rownames(vol.qual.field) %in% files_exclude) ,]
meta.field <- metadata.field[metadata.field$type == "floral" & !(metadata.field$sample %in% files_exclude),-48] %>%#48 is the second sample colum (skips)
  droplevels() %>% mutate(species=factor(species), time=factor(time))
vol.qual.field <- vol.qual.field / (as.numeric(meta.field$equil + meta.field$pumping)/3600) / meta.field$flowers #0.5 hr of equilibration plus 0.25 hr pumping, one flower
```

# Compare field and weatherport filtering

```{r compare_field}
print("both datasets:")
intersect(colnames(vol.qual), colnames(vol.qual.field))
print("weatherport, not field:")
setdiff(colnames(vol.qual), colnames(vol.qual.field))
print("field, not weatherport:")
setdiff(colnames(vol.qual.field), colnames(vol.qual))
```

# Quantitative integrations greenhouse & field

```{r quant}
# spreadsheet with all quant names: https://docs.google.com/spreadsheets/d/12S3xQonUx0tXOSGY2oT4sEpxtVdIBr1BEUIiWUXnSs0/edit?gid=1698770934#gid=1698770934

#field and greenhouse voc list
voclist<- unique(c(colnames(vol.qual), colnames(vol.qual.field), "indole"))
#TODO: add compounds with capital letters to compoound shortname list

#read in the large 2022 quant integration output and cut it down to NEXP chromatograms
source("read_shimadzu.R") #loads the function that reads the shimadzu output text file
# quantpath <- "~/MyDocs/MEGA/UCI/Schiedea/Analysis/scent/rmbl/RMBL Batches/quant_round3/"
# bfiles <-  list.files(quantpath)
# quant.full <- map_dfr(set_names(paste0(quantpath, bfiles), bfiles), read.shimadzu.quant, .id="batch") %>%
quant.full <- read.shimadzu.quant("data/quant_Ipo2022part1_5.txt") %>% #reads in shimadzu text file with quant integrations 
  #TODO: john update quant part 6
  mutate(Name = trimws(Name), Area=replace_na(Area, 0)) %>%
   distinct(Filename, Name, .keep_all=T) 
quant.full %>% select(Dirname, Filename, Name, Area) %>%
  mutate(Dirname = fct_relabel(Dirname, str_remove, "C:/GCMSsolution/Data/Project1_190815/")) %>%
  filter(Name != "1,6,10-Dodecatrien-3-ol, 3,7,11-trimethyl-") %>% #
  #1,6,10-Dodecatrien-3-ol, 3,7,11-trimethyl- is a real compound but not in Carries experiment
  #TODO: john add 1,6,10-Dodecatrien-3-ol, 3,7,11-trimethyl- to ipochem short names list
  mutate(Name = dplyr::recode(Name, !!!shortnames)) %>%
  mutate(Name = dplyr::recode(Name, "tricyclo[5.2.1.02,6]dec-2-ene"= "monoterpene A","3-ethenyl-1,2-dimethylcyclohexa-1,4-diene"= "monoterpene B","cosmene"= "monoterpene C", "p-mentha-1,3,8-triene"="monoterpene D" )) %>%  #renames retention time puzzel compounds to monoterpene A-D
  #filter(str_detect(Filename, "^NEXP")) %>%
  select(-Dirname) %>%
  pivot_wider(names_from="Name", values_from="Area") %>%
  write_tsv("data/quant_2022_exp1_exp1field.tsv")
vol.exp1.exp1field <- read_tsv("data/quant_2022_exp1_exp1field.tsv") 

#weatherport quant
vol <- vol.exp1.exp1field %>% #takes original file names and left joins it with verdicts 
  left_join(select(exp1.verdicts, Filename = FileName, sample2)) %>% drop_na(sample2) %>% #grabs two columns from verdicts - Filename (which is the origional filename on hard drive) and sample2 (which is the sample that is in that file name)
  select(-Filename) %>% rename(Filename = sample2) %>%  #replace FileName with the sample2 it holds (accounts for skips)
  column_to_rownames("Filename")
contams <- c("methyl salicylate", "benzaldehyde","trans-Geranylgeraniol","Decanal", "D-limonene", "Nonanoic acid", "Caprolactam",
             "(2E)-2,7-dimethylocta-2,6-dien-1-ol", #same peak as b-myrcene
             "3-methylbutanal oxime") #passed bouquet in OTC experiment but rare here

vol <- vol[rownames(vol.qual), c(intersect(voclist,colnames(vol)), "monoterpene A", "monoterpene B", "monoterpene C", "monoterpene D")] # rownames puts in same order as vol.qual; voclist filters list down to compounds only found in either greenhouse & field. Adds monoterpenes we removed back in
vol <- vol / (as.numeric(meta$equil + meta$pumping)/3600) / meta$flrs #0.5 hr of equilibration plus 0.25 hr pumping, one flower

#field quant
vol.field <-  vol.exp1.exp1field %>% #takes origional file names and left joins it with verdicts 
  left_join(select(exp1.field.verdicts, Filename = FileName, sample2)) %>% drop_na(sample2) %>% #grabs two columns from verdicts - Filename (which is the origional filename on hard drive) and sample2 (which is the sample that is in that file name)
  select(-Filename) %>% rename(Filename = sample2) %>%  #replace FileName with the sample2 it holds (accounts for skips)
  column_to_rownames("Filename")

vol.field <- vol.field[rownames(vol.qual.field), c(intersect(voclist,colnames(vol)), "monoterpene A", "monoterpene B", "monoterpene C", "monoterpene D")] 
vol.field <- vol.field / (as.numeric(meta.field$equil + meta.field$pumping)/3600) / meta.field$flowers #0.5 hr of equilibration plus 0.25 hr pumping, one flower


#compare lists
(added_quant <- setdiff(colnames(vol), colnames(vol.qual)))#in quant (from temp experiment) but do not pass filters in this dataset. Bc indole didn't pass qual tests but we want to look at it
#TODO: john - why shortnames not short?
(need_quant <- setdiff(colnames(vol.qual), colnames(vol))) # filtered volatiles that need quant integration. Passed bouquet but don't have quant for these compounds
#TODO: need quant to list above and below (excluding the compounds we renamed as monoterpene A-D)
(need_quant <- setdiff(colnames(vol.qual.field), colnames(vol.field))) #field bouquet filters. Ignore 4 we renamed but rest need quant integration. 
#vol <- bind_cols(vol, vol.qual[,need_quant]) #temporary, add a couple volatiles that don't have quant integrations yet (currently not on same scale!)
```

#Convert to ng/flower/hour
```{r}
#TODO: question for john - is this used later in the code? why is vol commented out at the bottom?

setdiff(voclist, shortnames) #these are the ones you need to figure out compound class for - assign to one of the standards we used.and change the name/add compound shortname

#Converting to ng/hr uses standards for 2022 on the GCMS
ipochemsf <- filter(ipochems, shortname%in%voclist)
#reads in spreadsheet with standard slopes in from johns github
read_csv(url("https://raw.githubusercontent.com/jmpowers/RMBL-GCMS/main/output/standards/regression_slopes.csv")) %>% filter(year == "2022b_newflowpath") 
#TODO :john - convert standards in the spreadsheet to shortnames 
#vol <- sweep(vol, 2, pull(ipochemsf, paste0("area_per_ng","2022")), FUN = '/')
  #sweep goes through every column in vol (which are all your compounds)
  #for each compound it divides by the slope of the standards which = area_per_ng

```


#combine field and greenhouse
```{r}
#combine greenhouse and field experiment data Ihyp -> ten, Lagg -> agg
megameta <- bind_rows(greenhouse=meta, .id = "experiment", field=meta.field %>% mutate(treatment=as.character(dplyr::recode(treatment,`watercontrol` = "low",control="low", nitrogen="high")), time=as.character(time), species= as.character(dplyr::recode(species, Ihyb="ten", Lagg="agg")))) 

mega.vol <- bind_rows(vol, vol.field)

```

#mega cap 
```{r}
(cap_treat <- vegan::capscale(sqrt(mega.vol) ~ time +experiment +species+ treatment+species*treatment+ time*species+time*treatment+ species*treatment*time, data=megameta))
anova.cca(cap_treat, by="term")

plot(cap_treat, type="n")
points(cap_treat, display="sites", 
       pch=c(1,19)[as.integer(factor(meta$time))],
       col=c("darkred","magenta")[as.integer(factor(meta$species))])
legend("topleft", legend=levels(factor((meta$species))), title="Species", fill=c("darkred","magenta"))
legend("topright", levels(factor((meta$time))), title="Time", pch=c(1,19))
text(cap_treat, display="species", cex=0.5, col=3)
text(cap_treat, display="cn", cex=0.5)
```


Find out how much variation there is between samples from same plant

```{r}

bd <- betadisper(vegdist(vol), meta$plantid) #gives bray curtis distance
plot(bd)
bdday <- betadisper(vegdist(vol[meta$time=="D",]), meta$plantid[meta$time=="D"])
plot(bdday)
bdnight <- betadisper(vegdist(vol[meta$time=="N",]), meta$plantid[meta$time=="N"])
plot(bdnight)
count(meta,species,plant) #number of samples per plant
##variation within one plant is similar to variation among all plants
##Do the plants have different levels of variation in their scents? 
##anova(bdday)
anova(bdday) #for day only
anova(bdnight)
anova(bd)

##are the plants different from one another
anova(capscale(vol~time*plantid, data=meta), by="term")
##yes the plants are unique when you throw out the variation due to time (or at least 1 plant is different than the rest)

#do day and night have different variances? 
#moth pollinated less variation at night? 
bdten <- betadisper(vegdist(vol[meta$species=="ten",]), meta$time[meta$species=="ten"])
plot(bdten)
anova(bdten) #no difference in spread of night vs day volatiles


bdagg <- betadisper(vegdist(vol[meta$species=="agg",]), meta$time[meta$species=="agg"])
plot(bdagg)
anova(bdagg)

bdihyb <- betadisper(vegdist(vol.field[meta.field$species=="Ihyb",]), meta.field$time[meta.field$species=="Ihyb"])
plot(bdihyb)
boxplot(bdihyb)
anova(bdihyb)

bdLagg <- betadisper(vegdist(vol.field[meta.field$species=="Lagg",]), meta.field$time[meta.field$species=="Lagg"])
plot(bdLagg)
anova(bdLagg)
#TODO: check metadata to make sure samples correctly listed as D vs N
```

#To find chromatogram with most diverse set compounds (for quantitative integrations)

```{r diverse, eval=FALSE}
##optional - look for a set of chromatograms that have all of the volatiles needed to set up Shimadzu quantitative integrations
# best <- list()
# i <- 1
# vol.left <- vol.qual[,need_quant]^(1/4) # halfway between areas and presence-absence
# while(ncol(vol.left)>0) {
#   print(dim(vol.left))
#   best[[i]] <- which.max(rowSums(vol.left))
#   vol.left <- vol.left[ , !decostand(vol.left[best[[i]],], method="pa"), drop=FALSE]
#   i <- i+1
# }
# (best.vol <- as.data.frame(t(vol.qual[unlist(best),need_quant])) %>% rownames_to_column("name"))
# chemtable %>% filter(name %in% need_quant) %>% select(name, RT, RT.var) %>% arrange(RT)
```

# Retention times
The puzzel - the 4 peaks we are not sure about compound identifications
prints out graphs
#terpenes 1-4

```{r retention, fig.width=12}
longdata.RT <- longdata %>% filter(name %in% c(colnames(vol.qual), colnames(vol))) %>%
  group_by(name) %>%  mutate(n=n(), RT.sd=sd(RT)) %>% ungroup() %>%
  mutate(name=fct_reorder(name, RT))

RT.tol <- 0.17  # 10 seconds before or after in quantitative params

#qual data, cosmene is showing up at 3 diff retention times which is impossible so that means 3 compounds are being identified as cosmene. Ions are shared among all 3 compounds. 4 compounds are: "p-mentha-1,3,8-triene", "carveol", "cosmene", "4,7-Methano-1H-indene, 2,4,5,6,7,7a-hexahydro-"
ggplot(longdata.RT, aes(x=RT, y=name,color=RT.sd)) + geom_jitter(width=0, height=0.4, size=1) +
  scale_color_viridis_c(option="magma") + geom_text(aes(x=4.5, label=n)) +
  stat_summary(fun="median", fun.max=~median(.x)+RT.tol, fun.min=~median(.x)-RT.tol, geom="pointrange", color="magenta", size=0.5, shape=15)

#TODO john - (already done?) delete (2E)-2,7-dimethylocta-2,6-dien-1-ol (same peak as b-myrcene) from quant integrations


mess <- c("p-mentha-1,3,8-triene", "carveol", "cosmene", "4,7-Methano-1H-indene, 2,4,5,6,7,7a-hexahydro-")
longdata.RT.mess <- longdata.RT %>% filter(name %in% mess) %>%
  arrange(RT) %>% mutate(cluster = kmeans(RT, 4, nstart=4)$cluster) %>%
  group_by(cluster) %>% mutate(RT.cluster = round(mean(RT),2)) %>% ungroup()

#shows 4 peaks that come up & their retention times. Color shows you what compound it gets identified as
ggplot(longdata.RT.mess, aes(x=factor(RT.cluster), fill=name)) + geom_bar()
#are there differences in retention times? answer: no
ggplot(longdata.RT.mess, aes(x=RT, color=name, fill=name)) + facet_wrap(vars(RT.cluster), scales="free_x") + theme_minimal() +
  geom_density(alpha=0.2, linewidth=2) + geom_jitter(aes(y=-as.integer(factor(name))*10), width=0.0002, height=4)

mess.wide <- longdata.RT.mess %>% select(sample, RT.cluster, area) %>% pivot_wider(names_from = RT.cluster, values_from=area, values_fn=sum, values_fill=0)
```


# Heatmap

## greenhouse

```{r heatmap, dev='png', dev.args=list()}
library(pheatmap)
library(dendsort)
library(viridis)
ph  <- pheatmap(as.matrix(t(vol))^(1/4), 
         cluster_cols=T, show_colnames=F,
         clustering_method="mcquitty", clustering_distance_rows="correlation",
         clustering_distance_cols=vegdist(vol, method = "bray"),
         clustering_callback = function(hc, ...){dendsort(hc, type="average")},
         scale="none", color=magma(512),
         annotation_col = data.frame(meta %>% select("species","treatment","time"), row.names=rownames(vol)),
         annotation_row = data.frame(added = as.integer(colnames(vol) %in% added_quant), 
                                     new = as.integer(colnames(vol) %in% new_quant),
                                     row.names=colnames(vol)),
   fontsize = 10, border_color = NA, legend=F, annotation_legend=T, cutree_rows=6
)
```


##field heatmap

```{r heatmap field, dev='png', dev.args=list()}
library(pheatmap)
library(dendsort)
library(viridis)
ph  <- pheatmap(as.matrix(t(vol.field))^(1/4), 
         cluster_cols=T, show_colnames=F,
         clustering_method="mcquitty", clustering_distance_rows="correlation",
         clustering_distance_cols=vegdist(vol.field, method = "bray"),
         clustering_callback = function(hc, ...){dendsort(hc, type="average")},
         scale="none", color=magma(512),
         annotation_col = data.frame(meta.field %>% select("species","treatment","time"), row.names=rownames(vol.field)),
         annotation_row = data.frame(added = as.integer(colnames(vol.field) %in% added_quant), 
                                     new = as.integer(colnames(vol.field) %in% new_quant),
                                     row.names=colnames(vol.field)),
   fontsize = 10, border_color = NA, legend=F, annotation_legend=T, cutree_rows=6
)
```

# Ordination

##weatherport - 
```{r cap}
(cap_treat <- vegan::capscale(sqrt(vol) ~ species + time + treatment, data=meta))
anova.cca(cap_treat, by="margin") # samples should be averaged by plant first
#species (p= 0.03 and time (p=0.001), treatment (p=0.05) effect

plot(cap_treat, type="n")
points(cap_treat, display="sites", 
       pch=c(1,19)[as.integer(factor(meta$time))],
       col=c("darkred","magenta")[as.integer(factor(meta$species))])
legend("topleft", legend=levels(factor((meta$species))), title="Species", fill=c("darkred","magenta"))
legend("topright", levels(factor((meta$time))), title="Time", pch=c(1,19))
text(cap_treat, display="species", cex=0.5, col=3)
text(cap_treat, display="cn", cex=0.5)
kable(arrange(as.data.frame(cap_treat$CCA$v), CAP1)) 

#ggvegan fortify() to make data frame of CAP to plot in ggplot
#code currently does not work
# cap_treat_dataframe <- fortify(cap_treat) #turns cap into data frame so you can run it in ggplot
# 
# #Ordination ggplot
# greenhouse_ordination <- ggplot(cap_treat_dataframe, aes(x = CAP1, y = CAP2, color = species, shape = time)) +
#   geom_point(size = 2.6) +
#   theme_classic() +
#   coord_fixed(xlim = c(-1.5, 2.9), ylim = c(-1, 2.4)) +
#   geom_hline(yintercept = 0, linetype = "dotted") +
#   geom_vline(xintercept = 0, linetype = "dotted") +
#   labs(color = "Species", shape = "Time") +
#   ggtitle("Grenhouse Volatiles") +
#   theme(
#     plot.title = element_text(hjust = 0.5),
#     legend.title = element_text(size = 12, color = "black"),
#     legend.text = element_text(size = 10),
#     legend.justification = c(0, 1),
#     legend.position = c(0.03, 0.95),
#     legend.background = element_blank(),
#     legend.key = element_blank(),
#     plot.subtitle = element_text(hjust = 1)
#   ) +
#   xlab("CAP1 (% explained)") +
#   ylab("MDS1 (% explained)") +
#   scale_color_manual(
#     name = "Nitrogen Level",
#     labels = c("High", "Low"),
#     values = c("orange", "skyblue")
#   ) +
#   labs(subtitle = "ANOVA; p=0.031", hjust = 1)
# 
# # Print the plot
# print(greenhouse_ordination)



```

##field
```{r cap.field}

(cap_treat_field <- vegan::capscale(sqrt(vol.field) ~ species + time + treatment, data=meta.field))
anova.cca(cap_treat_field, by="margin") # samples should be averaged by plant first
#species (p= 0.063), time (p=0.001)

plot(cap_treat_field, type="n")
points(cap_treat_field, display="sites", 
       pch=c(1,19)[as.integer(meta.field$time)],
       col=c("darkred","magenta")[as.integer(meta.field$species)])
legend("topleft", levels(meta.field$species), title="Species", fill=c("darkred","magenta"))
legend("topright", levels(meta.field$time), title="Time", pch=c(1,19))
text(cap_treat_field, display="species", cex=0.5, col=3)
text(cap_treat_field, display="cn", cex=0.5)
kable(arrange(as.data.frame(cap_treat_field$CCA$v), CAP1)) 

```

#Average volatiles

# Greenhouse Average VOCs
```{r}
#make average volatile table: 
noaverage <- bind_cols(meta,vol)%>%   #want to make table with metadata and volatile list that is not averaged to run Anova on
  group_by(time, treatment, species)%>%
  mutate(timetreatment=paste0(time,treatment)) #paste0 because glht doesn't like spaces in data sets

averagePlant<-bind_cols(meta,vol) %>% group_by(plantid, time, treatment, species) %>% 
  summarize(across(where(is.numeric),mean))  #takes average of each sample for day and night

averagetable<- averagePlant[,12:ncol(averagePlant)] #seperates table into meta data and volatile list table (not necesaary)
averagemetadata<- averagePlant[,1:11]

#cap species * treatment * time p=0.001
AverageVOCcapS.T.T <- capscale(sqrt(averagetable) ~ time*species*treatment, data = averagemetadata, distance = "bray")

anova(AverageVOCcapS.T.T, by="term")

```

# Field Average VOCs
```{r}
#make average volatile table: 
noaverage.field <- bind_cols(meta.field,vol.field)%>%   #want to make table with metadata and volatile list that is not averaged to run Anova on
  group_by(time, treatment, species)%>%
  mutate(timetreatment=paste0(time,treatment)) #paste0 because glht doesn't like spaces in data sets

averagePlant.field<-bind_cols(meta.field,vol.field) %>% group_by(plantid, time, treatment, species) %>% 
  summarize(across(where(is.numeric),mean)) %>% ungroup()    
#takes average of each sample for dayand night

averagetable.field<- averagePlant.field[,15:ncol(averagePlant.field)] #seperates table into meta data and volatile list table (not necesaary)
averagemetadata.field<- averagePlant.field[,1:14]

#Number of plants sampled for time, species and treatment
count(averagemetadata.field, species, time, treatment)

#cap species * treatment * time 
Field.AverageVOCcapS.T.T <- capscale(sqrt(averagetable.field) ~ time*species * treatment, data = averagemetadata.field, distance = "bray")

anova(Field.AverageVOCcapS.T.T, by="term")
#species p= 0.002, time p=0.001, species:time p=0.008


```


# Indole 

# Greenhouse Indole
```{r}
#make average tenuituba table
averageTENmetadata<- averagemetadata[averagemetadata$species=="ten",]
averageTENtable<-averagetable[averagemetadata$species=="ten",]
averageTEN <- bind_cols(averageTENmetadata, averageTENtable) %>%  #combines averaged meta data table and average volatile                                                                           list table together
  mutate(timetreatment=paste(time,treatment))           #want to combine time and treatment into the same colum bc glht                                                                   needs that
#only ten indole boxplot
ggplot(averageTEN, aes(color=treatment, x=time, y=indole))+geom_boxplot()+scale_y_sqrt() #box plot for TEN indole 

# agg and ten indole boxplot
facet.labs <- c(agg="I. aggregata", ten="I. tenuituba")
#averagePlant$species <- factor(averagePlant$species, levels = c("AGG", "TEN")) #orders species in figure legend
#averagePlant$treatment <- factor(averagePlant$treatment, levels = c("HIGH", "LOW")) #orders nitrogen levels in the figure legend

plot.indole.aggten=
  ggplot(averagePlant, aes(x=time, y=indole, color=treatment))+
  geom_boxplot(position=position_dodge(width=0.9))+
  geom_point (position=position_dodge(width=0.9))+ #makes it so point don't overlap
  scale_y_sqrt()+
  ylab("Indole Emissions")+
  xlab("") +
  facet_wrap(vars(species)) +
  facet_grid(. ~ species, labeller=labeller(species = facet.labs))+ 
  scale_x_discrete(labels=c('Day', 'Night', 'Day','Night'))+ #x axis text
  #ylim(0.1, 0.56) +  # Set y-axis limits from 0.1 to 0.56  
   NEXP1.theme +
  scale_color_manual(name="Nitrogen Level", 
          labels= c( high= "High nitrogen", low= "Low nitrogen"), 
          values=c(high="#b35f98", low="#3a8db3"))

print(plot.indole.aggten) 

ggsave(plot.indole.aggten, file='Indole_boxplot.jpg', width=150, height=110, units= 'mm', dpi=600)

library(car)
library(lmerTest)
library(lme4)

#Only indole lmer with plantid as random effect

noaverage$S.T.T <- factor(paste0(noaverage$species, noaverage$time, noaverage$treatment))
(indolelmer<-lmer(sqrt(indole)~S.T.T + (1|plantid), data=noaverage)) #use not averaged data! d
summary(multcomp::glht(indolelmer, linfct= multcomp::mcp(S.T.T = c("aggDhigh-aggDlow == 0","aggNhigh - aggNlow == 0", "tenNhigh - tenNlow == 0", "tenDhigh-tenDlow==0"))))
#

```

# Field Indole
```{r}
#make average Hybrid table
averageHYBmetadata.field<- averagemetadata.field[averagemetadata.field$species=="Ihyb",]

averageHYBtable.field<-averagetable.field[averagemetadata.field$species=="Ihyb",]
averageHYB.field <- bind_cols(averageHYBmetadata.field, averageHYBtable.field) %>%  #combines averaged meta data table and average volatile                                                                           list table together
  mutate(timetreatment=paste(time,treatment))           #want to combine time and treatment into the same colum bc glht                                                                   needs that
#only hybrid indole boxplot
ggplot(averageHYB.field, aes(color=treatment, x=time, y=indole))+geom_boxplot()+scale_y_sqrt() #box plot for HYB indole 

# agg and ten indole boxplot
facet.labs <- c(Lagg="I. aggregata", Ihyb="Hybrids")
averagePlant.field$species <- factor(averagePlant.field$species, levels = c("Lagg", "Ihyb")) #orders species in figure legend
averagePlant.field$treatment <- factor(averagePlant.field$treatment, levels = c("nitrogen", "watercontrol", "control")) #orders nitrogen levels in the figure legend

plot.indole.Lagghyb.field=
  ggplot(averagePlant.field, aes(color=treatment, x=time,y=indole))+
  geom_boxplot(position=position_dodge(width=0.9))+
  geom_point (position=position_dodge(width=0.9))+ #makes it so point don't overlap
  scale_y_sqrt()+
  ylab("Indole Emissions")+
  xlab("") +
  facet_wrap(vars(species)) +
  facet_grid(. ~ species, labeller=labeller(species = facet.labs))+ 
  scale_x_discrete(labels=c('Day', 'Night', 'Day','Night'))+ #x axis text
  #ylim(0.1, 0.56) +  # Set y-axis limits from 0.1 to 0.56  
   NEXP1.theme +
   scale_color_manual(name="Nitrogen Level", 
          labels= c( nitrogen= "High nitrogen", watercontrol= "Low nitrogen", control="No water added"), 
          values=c(control="#8b9b31",nitrogen="#b35f98", watercontrol="#3a8db3"))

print(plot.indole.Lagghyb.field)    
ggsave(plot.indole.Lagghyb.field, file='Indole_field_agghyb_boxplot.jpg', width=150, height=110, units= 'mm', dpi=600)

library(car)
library(lmerTest)
library(lme4)

#Only indole lmer with plantid as random effect for field
#treatment has watercontrol and contorl; treatmentx2 combines watercontrol + control = low
noaverage.field$S.T.T <- factor(paste0(noaverage.field$species, noaverage.field$time, noaverage.field$treatmentx2))
(indolelmer.field<-lmer(sqrt(indole)~S.T.T + (1|plantid), data=noaverage.field)) #use not averaged data! d
summary(multcomp::glht(indolelmer.field, linfct= multcomp::mcp(S.T.T =c("LaggDnitrogen - LaggDcontrol == 0","LaggNnitrogen - LaggNcontrol == 0", "IhybNnitrogen - IhybNcontrol == 0", "IhybDnitrogen - IhybDcontrol==0"))))

#no significant p values :(
  
  #c("LaggDnitrogen - LaggDcontrol == 0","LaggNnitrogen - LaggNcontrol == 0", "IhybNnitrogen - IhybNcontrol == 0", "IhybDnitrogen - IhybDcontrol==0"))))
  #"Tukey"


```

#compound changes (see below -> individual compound changes)

# Greenhouse compound changes
```{r}

#library(lme4)
#library(lmerTest)
#library(broom.mixed)
#library(dplyr)


#compoundmodels <- bind_cols(vol, meta) %>% 
#  pivot_longer(all_of(colnames(vol)), names_to="chem", values_to="amount")%>% # move volatiles into column
#  group_by(species, time, chem) %>%  #tells nest what to nest by species, time and chemical name
#    nest() %>% 
#    mutate(model=map(data, ~lmer(sqrt(amount)~ treatment + (1|plantid), data=.x)),
#           test=map(model, ~ tidy(anova(.x)))) #anova on each compound in each subset of species and time, stores in                                                                    column test
#compoundtests <- compoundmodels %>% dplyr::select(test) %>% 
#  unnest(test) %>% mutate(p.adjusted= p.adjust(p.value, method = "bonferroni", n=108)) #read wiki page on false discovery

#how much of a difference the treatment made
#compoundchanges <- compoundmodels %>% mutate(coef= map(model, ~tidy(.x))) %>% 
#  dplyr::select(coef) %>% unnest(coef) %>%
#  summarise(nitrogeneffect= estimate[1]/(estimate[1]+estimate[2]), p.value=p.value[2])  #nitrogeneffect = change of compound (i.e. X compound increased 3.2 fold in high nitrogen treatment
# for nitrogeneffect subtract by 1 to get the % change
```


# Greenhouse- I. tenuituba Day Volatiles

```{r}
 
TENdaytable<-averageTENtable[averageTENmetadata$time=="D",]
TENdaymetadata<-averageTENmetadata[averageTENmetadata$time=="D",]

TENcapday <- capscale(sqrt(TENdaytable) ~ treatment , data = TENdaymetadata, distance = "bray")

anova(TENcapday, by="term")
#p=0.86

```

#Greenhouse- I. tenuituba Night Volatiles

```{r}
TENnighttable<-averageTENtable[averageTENmetadata$time=="N",]
TENnightmetadata<-averageTENmetadata[averageTENmetadata$time=="N",]

TENcapnight <- capscale(sqrt(TENnighttable) ~  treatment, data = TENnightmetadata, distance = "bray") #no interaction terms bc only looking at tenuituba at night

anova(TENcapnight, by="term")
#p=0.229
```

# Treatment only CAPs
## Greenhouse- I. aggregata Daytime Volatiles

```{r}
averageaggmetadata<- averagemetadata[averagemetadata$species=="agg"& averagemetadata$time=="D",]
averageaggtable<-averagetable[averagemetadata$species=="agg"& averagemetadata$time=="D",]

agg.day.cap <- capscale(sqrt(averageaggtable) ~ treatment, data = averageaggmetadata, distance = "bray")

#To get % explained (= eigenvalues) for each cap axis
eig <-eigenvals(agg.day.cap)
axis.eig <- eig/ sum(eig)
print(axis.eig)

#remotes::install_github("gavinsimpson/ggvegan")
library(ggvegan)
library(dplyr)

cap.dataframe <- fortify(agg.day.cap) #turns cap into data frame so you can run it in ggplot
#autoplot(agg.day.cap) #plots cap


##generate a plot in ggplot
agg.Day.ordination = ggplot(bind_cols(filter(cap.dataframe, score=="sites"),averageaggmetadata), aes(x=CAP1, y= MDS1, color = treatment)) + 
  geom_point(size=2.6) +
  theme_classic() + 
  coord_fixed(xlim=c(-1.5, 2.9), ylim=c(-1, 2.4)) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  labs(color = "Treatment", fill = "Treatment") +
 # ggtitle("I. aggregata Daytime Volatiles") +
  theme(plot.title = element_text(hjust = 0.5))+
  ylab("MDS1 (33.2% explained)") + 
  xlab("CAP1 (12.5% explained)") + 
  scale_color_manual(name="Nitrogen Level", labels= c("High", "Low"), values=c("orange","skyblue")) +
  labs(subtitle="ANOVA; p=0.031",hjust = 1)+ #adds subtitle at top of figure
   theme(legend.title = element_text(size=12, color = "black"), legend.text=element_text(size=10),
           legend.justification=c(0,1), 
           legend.position=c(0.03, 0.95),
           legend.background = element_blank(),
           legend.key = element_blank(),
            plot.subtitle = element_text(hjust = 1)) #moves subtitle to right side 
  
    
print(agg.Day.ordination)
ggsave(agg.Day.ordination, file='agg_Day_ordinationplot.jpg', width=130, height=105, units= 'mm', dpi=600)

###################################################

#Compound names on ordination plot
library(ggrepel) #makes it so labels don't overlap

ggplot(filter(cap.dataframe, score=="species", sqrt(CAP1^2+MDS1^2)>0), aes(x=CAP1, y= MDS1)) + 
  geom_point()+
  geom_text_repel(aes(label=label)) +
  theme_classic() + 
  #coord_fixed(xlim=c(-1.25, 1), ylim=c(-1.5, 0.4)) +#coord fixed evenly scales x&y
  geom_hline(yintercept = 0, linetype="dotted") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  labs(color = "Treatment", fill = "Treatment") +
 # ggtitle("I. aggregata Daytime Volatiles") +
  theme(plot.title = element_text(hjust = 0.5))+
  ylab("MDS1") + 
  xlab("CAP1") 


#text(cap, display = "species", col="grey50")
#text(cap, display = "cn", labels= c("Day","Night","High Nitrogen","Low Nitrogen"), col="gray")
########################################################

anova(agg.day.cap, by="term")
#p=0.021

```

## Greenhouse- I. agg Night time volatiles (average)
```{r}
averageaggmetadataNIGHT<- averagemetadata[averagemetadata$species=="agg"& averagemetadata$time=="N",]
averageaggtableNIGHT<-averagetable[averagemetadata$species=="agg"& averagemetadata$time=="N",]

agg.night.cap <- capscale(sqrt(averageaggtableNIGHT) ~ treatment, data = averageaggmetadataNIGHT, distance = "bray")

#eig <-eigenvals(agg.day.cap)
#axis.eig <- eig/ sum(eig)
anova(agg.night.cap, by="term")

#p=0.593
```

##Field day and night emission rate

##hybrid day emission rate 
```{r}
averageHYBmetadataDAY.field<- averagemetadata.field[averagemetadata.field$species=="Ihyb"& averagemetadata.field$time=="D",]

averageHYBtableDAY.field<-averagetable.field[averagemetadata.field$species=="Ihyb"& averagemetadata.field$time=="D",]

averageHYBday.field <- bind_cols(averageHYBmetadataDAY.field, averageHYBtableDAY.field)# %>%  #combines averaged meta data table and average volatile                                                                           list table together
#  mutate(timetreatment=paste(time,treatment)) 


ihyb.day.cap <- capscale(sqrt(averageHYBtableDAY.field) ~ treatment, data = averageHYBmetadataDAY.field[, c("treatment")], distance = "bray")

#eigen values to get % explained
#eig.ihyb.day <-eigenvals(ihyb.day.cap)
#axis.eig.ihyb.day <- eig.ihyb.day/ sum(eig.ihyb.day)

anova(ihyb.day.cap, by="term")

```

##hybrid night emission rate 
```{r}
averageHYBmetadataNIGHT.field<- averagemetadata.field[averagemetadata.field$species=="Ihyb"& averagemetadata.field$time=="N",]

averageHYBtableNIGHT.field<-averagetable.field[averagemetadata.field$species=="Ihyb"& averagemetadata.field$time=="N",]

averageHYBnight.field <- bind_cols(averageHYBmetadataNIGHT.field, averageHYBtableNIGHT.field)# %>%  #combines averaged meta data table and average volatile                                                                           list table together
#  mutate(timetreatment=paste(time,treatment)) 


ihyb.night.cap <- capscale(sqrt(averageHYBtableNIGHT.field) ~ treatment, data = averageHYBmetadataNIGHT.field, distance = "bray")

#eigen values to get % explained
#eig.ihyb.day <-eigenvals(ihyb.day.cap)
#axis.eig.ihyb.day <- eig.ihyb.day/ sum(eig.ihyb.day)

anova(ihyb.night.cap, by="term")
#p=0.838
```

#Field Lagg emission rate day vs night

##Field Lagg emission rate DAY
```{r}
#Average Lagg for day and night
averageLaggmetadata.field<- averagemetadata.field[averagemetadata.field$species=="Lagg",]

averageLaggtable.field<-averagetable.field[averagemetadata.field$species=="Lagg",]

#Average Lagg for DAY only
averageLaggmetadataDAY.field<- averagemetadata.field[averagemetadata.field$species=="Lagg"& averagemetadata.field$time=="D",]

averageLaggtableDAY.field<-averagetable.field[averagemetadata.field$species=="Lagg"& averagemetadata.field$time=="D",]

averageLaggday.field <- bind_cols(averageLaggmetadataDAY.field, averageLaggtableDAY.field)# %>%  #combines averaged meta data table and average volatile                                                                           list table together
#  mutate(timetreatment=paste(time,treatment)) 


Lagg.day.cap <- capscale(sqrt(averageLaggtableDAY.field) ~ treatment, data = averageLaggmetadataDAY.field[, c("treatment")], distance = "bray")

#eigen values to get % explained
#eig.ihyb.day <-eigenvals(ihyb.day.cap)
#axis.eig.ihyb.day <- eig.ihyb.day/ sum(eig.ihyb.day)

anova(Lagg.day.cap, by="term")
#p=0.417
```

##Field Lagg emission rate NIGHT
```{r}

#average Lagg metadata and table for Night
averageLaggmetadataNIGHT.field<- averagemetadata.field[averagemetadata.field$species=="Lagg"& averagemetadata.field$time=="N",]

averageLaggtableNIGHT.field<-averagetable.field[averagemetadata.field$species=="Lagg"& averagemetadata.field$time=="N",]


averageLaggnight.field <- bind_cols(averageLaggmetadataNIGHT.field, averageLaggtableNIGHT.field)# %>%  #combines averaged meta data table and average volatile                                                                           list table together
#  mutate(timetreatment=paste(time,treatment)) 


Lagg.night.cap <- capscale(sqrt(averageLaggtableNIGHT.field) ~ treatment, data = averageLaggmetadataNIGHT.field, distance = "bray")

#eigen values to get % explained
#eig.ihyb.day <-eigenvals(ihyb.day.cap)
#axis.eig.ihyb.day <- eig.ihyb.day/ sum(eig.ihyb.day)

anova(Lagg.night.cap, by="term")
#p=0.19
```

#CAP species x treatment (Separate by time)

##CAP greenhouse ST for day and night
```{r}
####### Day ############
#create meta data with only daytime 
averagemetadata.DAY<- averagemetadata[averagemetadata$time=="D",]
averagetable.DAY<-averagetable[averagemetadata$time=="D",]

average.day <- bind_cols(averagemetadata.DAY, averagetable.DAY) #combines averaged meta data table and average volatile                                                                           list table together

#CAP - day
day.cap <- capscale(sqrt(averagetable.DAY) ~ species*treatment, data = averagemetadata.DAY, distance = "bray")
summary(day.cap)
#anova of day cap
anova(day.cap, by="term")

#To get % explained (= eigenvalues) for each cap axis
eig.day.cap <-eigenvals(day.cap)
axis.eig.day.cap <- eig.day.cap/ sum(eig.day.cap)
print(axis.eig.day.cap)

cap.day.dataframe <- fortify(day.cap) #turns cap into data frame so you can run it in ggplot
#autoplot(agg.day.cap) #plots cap


##generate a plot in ggplot
Day.ordination = ggplot(bind_cols(filter(cap.day.dataframe, score=="sites"),averagemetadata.DAY), aes(x=CAP1, y= CAP2, color = treatment, shape = species)) + 
  geom_point(size=2.6) +
  theme_classic() + 
  #coord_fixed(xlim=c(-1.5, 2.9), ylim=c(-1, 2.4)) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  labs(color = "Treatment", fill = "Treatment") +
 # ggtitle("I. aggregata Daytime Volatiles") +
  theme(plot.title = element_text(hjust = 0.5))+
  ylab("CAP2 (4.7% explained)") + 
  xlab("CAP1 (5.4% explained)") + 
  #labs(shape = "Species") +
  scale_color_manual(name="Nitrogen Level", 
          labels= c( high= "High nitrogen", low= "Low nitrogen"), 
          values=c(high="#b35f98", low="#3a8db3"),
          guide = guide_legend(order = 1))+  # Treatment legend appears first
  scale_shape_manual(
    name = "Species",  # Capitalize "Species"
    labels = c("agg" = expression(italic("I. aggregata")),
               "ten" = expression(italic("I. tenuituba"))),  # Italicize names
     values = c("agg" = 16, "ten" = 17))+  # Assign shapes explicitly 
  #labs(subtitle="ANOVA; p=0.031",hjust = 1)+ #adds subtitle at top of figure
   theme(legend.title = element_text(size=12, color = "black"), legend.text=element_text(size=10),
           legend.justification=c(0,1), 
           legend.position = "right",
           #legend.position=c(0.03, 0.95),
           legend.background = element_blank(),
           legend.key = element_blank(),
            plot.subtitle = element_text(hjust = 1)) #moves subtitle to right side 
  
    
print(Day.ordination)
ggsave(Day.ordination, file='Day_ordinationplot.jpg', width=130, height=105, units= 'mm', dpi=600)

######## NIGHT #################

#create meta data with only daytime 
averagemetadata.NIGHT<- averagemetadata[averagemetadata$time=="N",]
averagetable.NIGHT<-averagetable[averagemetadata$time=="N",]

average.night <- bind_cols(averagemetadata.NIGHT, averagetable.NIGHT) #combines averaged meta data table and average volatile                                                                           list table together

#CAP - day
night.cap <- capscale(sqrt(averagetable.NIGHT) ~ species*treatment, data = averagemetadata.NIGHT, distance = "bray")

#anova of day cap
anova(night.cap, by="term")

#To get % explained (= eigenvalues) for each cap axis
eig.night.cap <-eigenvals(night.cap)
axis.eig.night.cap <- eig.night.cap/ sum(eig.night.cap)
print(axis.eig.night.cap)

cap.night.dataframe <- fortify(night.cap) #turns cap into data frame so you can run it in ggplot


##generate a plot in ggplot
Night.ordination = ggplot(bind_cols(filter(cap.night.dataframe, score=="sites"),averagemetadata.NIGHT), aes(x=CAP1, y= CAP2, color = treatment, shape = species)) + 
  geom_point(size=2.6) +
  theme_classic() + 
  #coord_fixed(xlim=c(-1.5, 2.9), ylim=c(-1, 2.4)) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  labs(color = "Treatment", fill = "Treatment") +
 # ggtitle("I. aggregata Night Volatiles") +
  theme(plot.title = element_text(hjust = 0.5))+
  ylab("CAP2 (2.1% explained)") + 
  xlab("CAP1 (3.4% explained)") + 
  #labs(shape = "Species") +
  scale_color_manual(name="Nitrogen Level", 
          labels= c( high= "High nitrogen", low= "Low nitrogen"), 
          values=c(high="#b35f98", low="#3a8db3"),
          guide = guide_legend(order = 1))+  # Treatment legend appears first
  scale_shape_manual(
    name = "Species",  # Capitalize "Species"
    labels = c("agg" = expression(italic("I. aggregata")),
               "ten" = expression(italic("I. tenuituba"))),  # Italicize names
    values = c("agg" = 16, "ten" = 17))+  # Assign shapes explicitly 
  #labs(subtitle="ANOVA; p=0.031",hjust = 1)+ #adds subtitle at top of figure
   theme(legend.title = element_text(size=12, color = "black"), legend.text=element_text(size=10),
           legend.justification=c(0,1), 
           legend.position = "right",
           #legend.position=c(0.03, 0.95),
           legend.background = element_blank(),
           legend.key = element_blank(),
            plot.subtitle = element_text(hjust = 1)) #moves subtitle to right side 
  
    
print(Night.ordination)
ggsave(Night.ordination, file='Night_ordinationplot.jpg', width=130, height=105, units= 'mm', dpi=600)

```

##CAP field ST for day and night
```{r}
####### Day ############
#create meta data with only daytime 
averagemetadata.DAY.field<- averagemetadata.field[averagemetadata.field$time=="D",]
averagetable.DAY.field<-averagetable.field[averagemetadata.field$time=="D",]

average.day.field <- bind_cols(averagemetadata.DAY.field, averagetable.DAY.field) #combines averaged meta data table and average volatile                                                                           list table together

#CAP - day
day.cap.field <- capscale(sqrt(averagetable.DAY.field) ~ species*treatment, data = averagemetadata.DAY.field, distance = "bray")

#anova of day cap
anova(day.cap.field, by="term")

#To get % explained (= eigenvalues) for each cap axis
eig.day.cap.field <-eigenvals(day.cap.field)
axis.eig.day.cap.field <- eig.day.cap.field/ sum(eig.day.cap.field)
print(axis.eig.day.cap.field)

cap.day.dataframe.field <- fortify(day.cap.field) #turns cap into data frame so you can run it in ggplot
#autoplot(agg.day.cap) #plots cap


##generate a plot in ggplot
Day.ordination.field = ggplot(bind_cols(filter(cap.day.dataframe.field, score=="sites"),averagemetadata.DAY.field), aes(x=CAP1, y= CAP2, color = treatment, shape = species)) + 
  geom_point(size=2.6) +
  theme_classic() + 
  #coord_fixed(xlim=c(-1.5, 2.9), ylim=c(-1, 2.4)) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  labs(color = "Treatment", fill = "Treatment") +
 # ggtitle("I. aggregata Daytime Volatiles") +
  theme(plot.title = element_text(hjust = 0.5))+
  ylab("CAP2 (4.7% explained)") + 
  xlab("CAP1 (5.4% explained)") + 
  #labs(shape = "Species") +
  scale_color_manual(name="Nitrogen Level", 
          labels= c(control="No water added", nitrogen= "High nitrogen", watercontrol= "Low nitrogen"), 
          values=c(control="#8b9b31",nitrogen="#b35f98", watercontrol="#3a8db3"),
          guide = guide_legend(order = 1))+  # Treatment legend appears first
  scale_shape_manual(
    name = "Species",  # Capitalize "Species"
    labels = c("Lagg" = expression(italic("I. aggregata")),   # Italicize names
               "Ihyb" ="Hybrids"), 
   values = c("Lagg" = 16, "Ihyb" = 17))+  # Assign shapes explicitly 
  #labs(subtitle="ANOVA; p=0.031",hjust = 1)+ #adds subtitle at top of figure
   theme(legend.title = element_text(size=12, color = "black"), legend.text=element_text(size=10),
           legend.justification=c(0,1), 
           legend.position = "right",
           #legend.position=c(0.03, 0.95),
           legend.background = element_blank(),
           legend.key = element_blank(),
            plot.subtitle = element_text(hjust = 1)) #moves subtitle to right side 
  
    
print(Day.ordination.field)
ggsave(Day.ordination.field, file='Day_ordinationplot_field.jpg', width=130, height=105, units= 'mm', dpi=600)

######## NIGHT #################

#create meta data with only daytime 
averagemetadata.NIGHT.field<- averagemetadata.field[averagemetadata.field$time=="N",]
averagetable.NIGHT.field<-averagetable.field[averagemetadata.field$time=="N",]

average.night.field <- bind_cols(averagemetadata.NIGHT.field, averagetable.NIGHT.field) #combines averaged meta data table and average volatile                                                                           list table together

#CAP - day
night.cap.field <- capscale(sqrt(averagetable.NIGHT.field) ~ species*treatment, data = averagemetadata.NIGHT.field, distance = "bray")

#anova of day cap
anova(night.cap.field, by="term")

#To get % explained (= eigenvalues) for each cap axis
eig.night.cap.field <-eigenvals(night.cap.field)
axis.eig.night.cap.field <- eig.night.cap.field/ sum(eig.night.cap.field)
print(axis.eig.night.cap.field)

cap.night.dataframe.field <- fortify(night.cap.field) #turns cap into data frame so you can run it in ggplot


##generate a plot in ggplot
Night.ordination.field = ggplot(bind_cols(filter(cap.night.dataframe.field, score=="sites"),averagemetadata.NIGHT.field), aes(x=CAP1, y= CAP2, color = treatment, shape = species)) + 
  geom_point(size=2.6) +
  theme_classic() + 
  #coord_fixed(xlim=c(-1.5, 3), ylim=c(-1.5, 3)) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  labs(color = "Treatment", fill = "Treatment") +
 # ggtitle("") +
  theme(plot.title = element_text(hjust = 0.5))+
  ylab("CAP2 (13.8% explained)") + 
  xlab("CAP1 (1.2% explained)") + 
  #labs(shape = "Species") +
  scale_color_manual(name="Nitrogen Level", 
          labels= c(control="No water added", nitrogen= "High nitrogen", watercontrol= "Low nitrogen"), 
          values=c(control="#8b9b31",nitrogen="#b35f98", watercontrol="#3a8db3"),
          guide = guide_legend(order = 1))+  # Treatment legend appears first
  scale_shape_manual(
    name = "Species",  # Capitalize "Species"
    labels = c("Lagg" = expression(italic("I. aggregata")),   # Italicize names
               "Ihyb" ="Hybrids"), 
    values = c("Lagg" = 16, "Ihyb" = 17))+  # Assign shapes explicitly 
  #labs(subtitle="ANOVA; p=0.031",hjust = 1)+ #adds subtitle at top of figure
   theme(legend.title = element_text(size=12, color = "black"), legend.text=element_text(size=10),
           legend.justification=c(0,1), 
           legend.position = "right",
           #legend.position=c(0.03, 0.95),
           legend.background = element_blank(),
           legend.key = element_blank(),
            plot.subtitle = element_text(hjust = 1)) #moves subtitle to right side 
  
    
print(Night.ordination.field)
ggsave(Night.ordination.field, file='Night_ordinationplot_field.jpg', width=130, height=105, units= 'mm', dpi=600)

```


# Total emissions 

## Greenhouse- total emissions
```{r}
#Need average agg and ten for boxplot 
averageaggmetadata$totalemssions <-rowSums(averageaggtable) #sums rows of volatiles to get total emissions (via adding all peak areas) for each sample

meta$totalemission <- rowSums(vol)  #attatches row sums to metadata 

total.emission.model <-lmer(totalemission~treatment*species*time + (1|plantid), data=meta) #models looks at total emissions as a function of treatment*species*time with plantid as a random effect
gh.total.emission.anova <- Anova(total.emission.model, type=3) #type 3 anova on the model to get p-value
print(gh.total.emission.anova)

library(emmeans)
#emmeans table 
total.emmeans<-emmeans(total.emission.model,c("time", "species")) 

library(knitr)    
kable(total.emmeans, digits=3) #spits out model into table
#now divide 'estimate' high by low to get % change
#total emissions 23% higher at night 

#######################################
meta$S.T.T <- paste0(meta$species, meta$time, meta$treatment) #add column with species, treatment and time to metadata. Need for glht

#finding p-values to compare treatment within each of the four groups
total.emission.model2 <-lmer(totalemission~S.T.T + (1|plantid), data=meta)

#to get emmeans for % change
library(emmeans)

emmeans(total.emission.model2, "S.T.T") #c("treatment", "species", "time")

#divide high/low -> get percent change from high to low

Anova(total.emission.model2, type=3)

#library(multcomp)

#general linear hypotheses
  #subtracts means from different groups (like Agg day low - agg day high) c
      #can specify which group like below or write linfct=mcp(model ="Tukey"))
  # summary () gives you p-values

multcomp:::summary.glht(multcomp::glht(total.emission.model2, linfct=multcomp::mcp(S.T.T= 
                                           c("aggDlow - aggDhigh == 0",
                                             "aggNlow-aggNhigh==0", 
                                             "tenDlow-tenDhigh==0",
                                             "tenNlow-tenNhigh==0"))),                                                               test=multcomp::adjusted(type="fdr"))

#total emissions change at night time between high and low in agg p=0.0349


#total emissions pretty - greenhouse 

facet.labs <- c(agg="I. aggregata", ten="I. tenuituba")
meta$species <- factor(meta$species, levels = c("agg", "ten")) #agg is on left facet panel, ten is right side

plot.total.emissions.pretty=
  ggplot(meta, aes( y= totalemission, x=str_to_title(time), color=treatment)) +
  geom_boxplot(position=position_dodge(width=0.9))+
  geom_point (position=position_dodge(width=0.9))+ #makes it so point don't overlap
  scale_y_sqrt()+
  ylab("Total Emissions")+
  xlab("") +
  NEXP1.theme +
  #facet_wrap(. ~species, labeller = labeller(species = c("agg" = expression(italic("I. aggregata")),
   # "ten" = expression(italic("I. tenuituba"))))) +
  facet_grid(. ~ species, labeller=as_labeller(facet.labs)) + 
  scale_x_discrete(labels=c('Day', 'Night', 'Day','Night')) + #x axis text
  scale_color_manual(name="Nitrogen Level", 
          labels= c( high= "High nitrogen", low= "Low nitrogen"), 
          values=c(high="#b35f98", low="#3a8db3"))


print(plot.total.emissions.pretty)
ggsave(plot.total.emissions.pretty, file='greenhouse_totalemissions.jpg', width=150, height=140, units= 'mm', dpi=600)
```



## Field- total emissions
```{r}
#Average Lagg for day and night
averageLaggmetadata.field<- averagemetadata.field[averagemetadata.field$species=="Lagg",]
averageLaggtable.field<-averagetable.field[averagemetadata.field$species=="Lagg",]

#average Ihyb total emissions = row sums 
averageHYBmetadata.field$totalemssions <-rowSums(averageHYBtable.field) #sums rows of volatiles to get total emissions (via adding all peak areas) for each sample

#average Lagg total emissions = row sums 
averageLaggmetadata.field$totalemssions <-rowSums(averageLaggtable.field)

meta.field$totalemission <- rowSums(vol.field)  #attatches row sums to metadata 

total.emission.model.field <-lmer(totalemission~treatment*species*time + (1|plantid), data=meta.field) #models looks at total emissions as a function of treatment*species*time with plantid as a random effect
Anova(total.emission.model.field, type=3) #type 3 anova on the model to get p-value
#time p= 0.00053


#emmeans table 
field.total.emmeans<-emmeans(total.emission.model.field, c("time","species")) 

library(knitr)    
kable(field.total.emmeans, digits=3) #spits out model into table
#now divide 'estimate' high by low to get % change
#total emissions 19.3% higher at night 

##############################################
#boxplot of Total emissions for Agg and Ten day & night

facet.labs <- c(Lagg="I. aggregata", Ihyb="Hybrids")
meta.field$species <- factor(meta.field$species, levels = c("Lagg", "Ihyb")) #Lagg is on left facet panel, ihyb is right side
meta.field$treatment <- factor(meta.field$treatment, levels = c("nitrogen", "watercontrol", "control")) #orders nitrogen levels in the figure legend


plot.total.emissions.field=
  ggplot(meta.field, aes( y= totalemission, x=time, color=treatment))+ #could do with average metadata instead of all data points in meta
  geom_boxplot(position=position_dodge(width=0.9))+
  geom_point (position=position_dodge(width=0.9))+ #makes it so point don't overlap
  scale_y_sqrt()+
  ylab("Total Emissions")+
  xlab("") +
  facet_wrap(vars(species)) +
  facet_grid(. ~ species, labeller=labeller(species = facet.labs)) + 
  scale_x_discrete(labels=c('Day', 'Night', 'Day','Night')) + #x axis text
  NEXP1.theme +
  scale_color_manual(name="Nitrogen Level", 
          labels= c(nitrogen= "High nitrogen", watercontrol= "Low nitrogen", control="No water added"), 
          values=c(control="#8b9b31",nitrogen="#b35f98", watercontrol="#3a8db3"))
 
 
print(plot.total.emissions.field) 

ggsave(plot.total.emissions.field, file='total_emissions_field_boxplot.jpg', width=150, height=110, units= 'mm', dpi=600)

 ##Old figure code:
  
  # geom_boxplot(position=position_dodge(width=0.9))+
  # geom_point (position=position_dodge(width=0.9))+ #makes it so point don't overlap
  # scale_y_sqrt()+
  # ylab("Total Emissions")+
  # xlab("") +
  # facet_wrap(vars(species)) +
  #   facet_grid(. ~ species, labeller=labeller(species = facet.labs))+ 
  #   theme(panel.border = element_blank(),
  #     panel.grid.major = element_line(colour="white"),
  #     #panel.grid.minor = element_blank(),
  #     panel.background = element_rect(fill = "gray96",
  #                               #colour = "lightblue",
  #                                 linetype = "solid"),
  #     strip.text.x = element_text(size=11),
  #     strip.background = element_rect(colour="white", fill="white"))+
  #   scale_color_manual(name="Nitrogen Level", 
  #       #labels= c("High",  "Low"), #Specifies treatment names in legend
  #       values=c("pink","orange","skyblue"))+
  #   theme(legend.title = element_text(size=11, color = "black"),
  #       legend.text=element_text(size=9))+
  # scale_x_discrete(labels=c('Day', 'Night', 'Day','Night'))



#######################################

#glht for field total emissions 
meta.field$S.T.T <- paste0(meta.field$species, meta.field$time, meta.field$treatment) #add column with species, treatment and time to metadata. Need for glht

#finding p-values to compare treatment within each of the four groups 
total.emission.model2.field <-lmer(totalemission~S.T.T + (1|plantid), data=meta.field)

Anova(total.emission.model2.field, type=3)


#library(multcomp)

#general linear hypotheses
  #subtracts means from different groups (like Agg day low - agg day high) c
      #can specify which group like below or write linfct=mcp(model ="Tukey"))
  # summary () gives you p-values
total.emission.model2.field.glht <- summary(multcomp::glht(total.emission.model2.field, linfct=multcomp::mcp(S.T.T= c("IhybDnitrogen - IhybDcontrol == 0", "IhybDnitrogen - IhybDwatercontrol == 0", "IhybDcontrol - IhybDwatercontrol == 0", "IhybNnitrogen - IhybNcontrol == 0", "IhybNnitrogen - IhybNwatercontrol == 0", "IhybNcontrol - IhybNwatercontrol == 0","LaggDnitrogen - LaggDcontrol == 0 ", "LaggDnitrogen - LaggDwatercontrol == 0 ", "LaggDwatercontrol - LaggDcontrol == 0 ","LaggNnitrogen - LaggNcontrol == 0 ", "LaggNnitrogen - LaggNwatercontrol == 0 ", "LaggNwatercontrol - LaggNcontrol == 0 "))),
        
                                          # c("IhybDnitrogen - IhybDcontrol == 0", "IhybDnitrogen - IhybDwatercontrol == 0", "IhybDcontrol - IhybDwatercontrol == 0", "IhybNnitrogen - IhybNcontrol == 0", "IhybNnitrogen - IhybNwatercontrol == 0", "IhybNcontrol - IhybNwatercontrol == 0","LaggDnitrogen - LaggDcontrol == 0 ", "LaggDnitrogen - LaggDwatercontrol == 0 ", "LaggDwatercontrol - LaggDcontrol == 0 ","LaggNnitrogen - LaggNcontrol == 0 ", "LaggNnitrogen - LaggNwatercontrol == 0 ", "LaggNwatercontrol - LaggNcontrol == 0 "))),                                                              
  test=multcomp::adjusted(type="none"))

library(broom)
kable(tidy(total.emission.model2.field.glht))
```

# Individual compound change for treatment based on species and time

# Greenhouse- individual compound change for treatment 
```{r}
dominantvocs <-averagePlant%>% pivot_longer(any_of(colnames(vol)))%>%     group_by(species,time,treatment,name)%>% 
   summarise(value=mean(value))%>%
   # mutate(value=value/sum(value))%>% #adds up values for each treatment
  arrange(species, time, treatment, desc(value))

ggplot(dominantvocs, aes(y=fct_reorder(name, value), x=value, color=treatment, shape=time))+
         geom_point(size=3)+ #plots points
    scale_x_sqrt()+ #scales x axis so you can see small peak area dots
    facet_wrap(vars(species))+ #makes two pannels, agg and ten
    scale_color_manual(name="Nitrogen Level", 
          labels= c( high= "High nitrogen", low= "Low nitrogen"), 
          values=c(high="#b35f98", low="#3a8db3"))+ #manually change colros
    theme_minimal() #removed grey from background
    

```

# Field- individual compound change for treatment 
```{r}
dominantvocs.field <-averagePlant.field%>% pivot_longer(any_of(colnames(vol.field)))%>%     group_by(species,time,treatment,name)%>% 
   summarise(value=mean(value))%>%
   # mutate(value=value/sum(value))%>% #adds up values for each treatment
  arrange(species, time, treatment, desc(value))

ggplot(dominantvocs.field, aes(y=fct_reorder(name, value), x=value, color=treatment, shape=time))+
         geom_point(size =3)+ #plots points
    scale_x_sqrt()+ #scales x axis so you can see small peak area dots
    facet_wrap(vars(species))+ #makes two pannels, agg and ten
    scale_color_manual(name="Nitrogen Level", 
          labels= c(control="No water added", nitrogen= "High nitrogen", watercontrol= "Low nitrogen"), 
          values=c(control="#8b9b31",nitrogen="#b35f98", watercontrol="#3a8db3")) #manually change colros
    theme_minimal() #removed grey from background
    

```

#anova on specific/individual compounds 

# Greenhouse-anova on specific/individual compounds
```{r}
#library(broom.mixed)
#library(dplyr)
#library(lme4)

#individualcompoundpvalue <- bind_cols(meta, vol) %>% 
#  pivot_longer(all_of(colnames(vol))) %>%
#  group_by(species,time, name)%>%
#  nest() %>% mutate(model=map(data, ~lmer(value~ treatment + (1|plantid), data=.x))) %>%  

# mutate adds column, we are adding model column; map runs a for loop through data column  only once; value = emission rate in ng/hr; ~ says run this function; .x is empty data frame model stores values in
  
#  mutate(test=map(model, ~tidy(anova(.x)))) %>% 
#  dplyr::select(test) %>%   #select(test) makes unnesting happier
#  unnest()%>% ungroup()%>%                         
 # mutate(p.adjusted=p.adjust(p.value, method="fdr")) #p.adjust adjusts p-value

#View(individualcompoundpvalue)

```

# Relative Amount

# Greenhouse- relative amount
```{r}
library(vegan)
library(dplyr)

# Total relative amount divide by margin total 
relativeamount.vol <- decostand(vol, "total")

relativeamount <- bind_cols(meta, relativeamount.vol) %>% 
   pivot_longer(all_of(colnames(vol))) %>% 
  group_by(species,time, name)%>% 
   dplyr::select(species, time, treatment, plantid, name, value)  

#View(relativeamount)

# Relative amount presents/ absents 0s & 1s 
relativeamountPA <- decostand(vol, "pa")

#View(relativeamountPA)

#cap on relative amount (with Square root transform) 
rel.amount.cap <- capscale(sqrt(relativeamount.vol) ~ treatment, data = meta, distance = "bray")

rel.amount.dataframe <- fortify(rel.amount.cap)
rel.amount.ordination = ggplot(bind_cols(filter(rel.amount.dataframe, score=="sites"),meta), aes(x=CAP1, y= MDS1, color = treatment)) + 
  geom_point(size=2.6) +
  theme_classic() + 
  coord_fixed(xlim=c(-1.5, 2.9), ylim=c(-1, 2.4)) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  labs(color = "Treatment", fill = "Treatment") +
 # ggtitle("I. aggregata Daytime Volatiles") +
  theme(plot.title = element_text(hjust = 0.5))+
  ylab("MDS1 (% explained)") + 
  xlab("CAP1 (% explained)") + 
  scale_color_manual(name="Nitrogen Level", 
          labels= c( high= "High nitrogen", low= "Low nitrogen"), 
          values=c(high="#b35f98", low="#3a8db3")) +
  labs(subtitle="ANOVA; p=0.264",hjust = 1)+ #adds subtitle at top of figure
   theme(legend.title = element_text(size=12, color = "black"), legend.text=element_text(size=10),
           legend.justification=c(0,1), 
           legend.position=c(0.03, 0.95),
           legend.background = element_blank(),
           legend.key = element_blank(),
            plot.subtitle = element_text(hjust = 1)) #moves subtitle to right side 
  
    
print(rel.amount.ordination)

anova(rel.amount.cap, by="term")
#p= 0.152

```


# Field- relative amount
```{r}
library(vegan)
library(dplyr)

# Total relative amount divide by margin total 
relativeamount.vol.field <- decostand(vol.field, "total")

relativeamount.field <- bind_cols(meta.field, relativeamount.vol.field) %>% 
   pivot_longer(all_of(colnames(vol.field))) %>% 
  group_by(species,time, name)%>% 
   dplyr::select(species, time, treatment, plantid, name, value)  

#View(relativeamount.field)

# Relative amount presents/ absents 0s & 1s 
relativeamountPA.field <- decostand(vol.field, "pa")

#View(relativeamountPA.field)

#cap on relative amount (with Square root transform) 
rel.amount.cap.field <- capscale(sqrt(relativeamount.vol.field) ~ treatment, data = meta.field, distance = "bray")

rel.amount.dataframe.field <- fortify(rel.amount.cap.field)
rel.amount.ordination.field = ggplot(bind_cols(filter(rel.amount.dataframe.field, score=="sites"),meta.field), aes(x=CAP1, y= MDS1, color = treatment)) + 
  geom_point(size=2.6) +
  theme_classic() + 
  coord_fixed(xlim=c(-1.5, 2.9), ylim=c(-1, 2.4)) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  labs(color = "Treatment", fill = "Treatment") +
 # ggtitle("I. aggregata Daytime Volatiles") +
  theme(plot.title = element_text(hjust = 0.5))+
  ylab("MDS1 (% explained)") + 
  xlab("CAP1 (% explained)") + 
  scale_color_manual(name="Nitrogen Level", 
          labels= c(control="No water added", nitrogen= "High nitrogen", watercontrol= "Low nitrogen"), 
          values=c(control="#8b9b31",nitrogen="#b35f98", watercontrol="#3a8db3")) + 
  labs(subtitle="ANOVA; p=0.451",hjust = 1)+ #adds subtitle at top of figure
   theme(legend.title = element_text(size=12, color = "black"), legend.text=element_text(size=10),
           legend.justification=c(0,1), 
           legend.position=c(0.03, 1),
           legend.background = element_blank(),
           legend.key = element_blank(),
            plot.subtitle = element_text(hjust = 1)) #moves subtitle to right side 
  
    
print(rel.amount.ordination.field)

anova(rel.amount.cap.field, by="term")
#p= 0.451

```

# Percent change of individual compounds for each species Night/Day with p-values

#Percent change Night/Day- field
```{r}
#compound % change 
compoundratios.field <- averagePlant.field %>% group_by(time, species) %>% 
  summarise(across(colnames(vol.field),mean)) %>%  #takes mean of each compound for each species and time
  pivot_longer(colnames(vol.field)) %>% #dplr can't divide rows but can divide columns so need to make compounds into columns
  pivot_wider(names_from = time, values_from = value) %>%  #name day column and night column
  mutate(NighttoDayRatio= N/D * 100)
library(broom)
compoundchangemodel.field <- averagePlant.field %>% pivot_longer(colnames(vol.field)) %>%
    group_by(species, name) %>% nest() %>% 
    mutate(model=map(data,~lm(value~time, data=.x))) %>% 
    mutate(test=map(model, ~tidy(anova(.x)))) %>% 
    select(-data, - model) %>% unnest(test) %>% 
    filter(term!="Residuals") %>% 
    mutate(significant= p.value< 0.05)

View(compoundchangemodel.field)

compoundpercentchange.field <- left_join(compoundratios.field,compoundchangemodel.field)
View(compoundpercentchange.field)

write_csv(compoundpercentchange.field, file = "Nexp1_Compound%change_DN.field.csv")
```

#Percent change Night/Day- greenhouse
```{r}
#compound % change 
compoundratios <- averagePlant %>% group_by(time, species) %>% 
  summarise(across(colnames(vol),mean)) %>%  #takes mean of each compound for each species and time
  pivot_longer(colnames(vol)) %>% #dplr can't divide rows but can divide columns so need to make compounds into columns
  pivot_wider(names_from = time, values_from = value) %>%  #name day column and night column
  mutate(NighttoDayRatio= N/D * 100)
#library(broom)
compoundchangemodel <- averagePlant %>% pivot_longer(colnames(vol)) %>%
    group_by(species, name) %>% nest() %>% 
    mutate(model=map(data,~lm(value~time, data=.x))) %>% 
    mutate(test=map(model, ~tidy(anova(.x)))) %>% 
    select(-data, - model) %>% unnest(test) %>% 
    filter(term!="Residuals") %>% 
    mutate(significant= p.value< 0.05)

View(compoundchangemodel)

compoundpercentchange <- left_join(compoundratios,compoundchangemodel)
View(compoundpercentchange)

write_csv(compoundpercentchange, file = "Nexp1_Compound%change_DN.csv")

```

#Greenhouse compound % change high/low nitrogen
```{r}
#compound % change Treatment low/high
library(tidyverse)
library(broom)

compoundratios.lowhigh <- averagePlant %>% group_by(time, species, treatment) %>% 
  summarise(across(colnames(vol),mean)) %>%  #takes mean of each compound for each species and time
  pivot_longer(colnames(vol)) %>% #dplr can't divide rows but can divide columns so need to make compounds into columns
  pivot_wider(names_from = treatment, values_from = value) %>%  #name day column and night column
  mutate(HighLowRatio= low/high * 100)
#library(broom)
compoundchangemodel.lowhigh <- averagePlant %>% pivot_longer(colnames(vol)) %>%
    group_by(species, name,time) %>% nest() %>% 
    mutate(model=map(data,~lm(value~treatment, data=.x))) %>% 
    mutate(test=map(model, ~tidy(anova(.x)))) %>% 
    select(-data, - model) %>% unnest(test) %>% 
    filter(term!="Residuals") %>% 
    mutate(significant= p.value< 0.05)

View(compoundchangemodel.lowhigh)

compoundpercentchange.lowhigh <- left_join(compoundratios.lowhigh,compoundchangemodel.lowhigh)
View(compoundpercentchange.lowhigh)

write_csv(compoundpercentchange.lowhigh, file = "Nexp1_Compound%change_lowhigh_greenhouse.csv")
```

#Field compound % change high/low nitrogen
#doesn't work bc 3 treatments, watercontrol two words
```{r}
#make treatment2 = watercontrol + control 

#compound % change Treatment low/high
compoundratios.lowhigh.field <- averagePlant.field %>% group_by(time, species, treatment) %>% 
  summarise(across(colnames(vol.field),mean)) %>%  #takes mean of each compound for each species and time
  pivot_longer(colnames(vol.field)) %>% #dplr can't divide rows but can divide columns so need to make compounds into columns
  pivot_wider(names_from = treatment, values_from = value) %>%  #name day column and night column
  mutate(HighLowRatio= `watercontrol`/nitrogen * 100)
#library(broom)
compoundchangemodel.lowhigh.field <- averagePlant.field %>% pivot_longer(colnames(vol.field)) %>%
    group_by(species, name) %>% nest() %>% 
    mutate(model=map(data,~lm(value~treatment, data=.x))) %>% 
    mutate(test=map(model, ~tidy(anova(.x)))) %>% 
    select(-data, - model) %>% unnest(test) %>% 
    filter(term!="Residuals") %>% 
    mutate(significant= p.value< 0.05)

View(compoundchangemodel.lowhigh.field)

compoundpercentchange.lowhigh.field <- left_join(compoundratios.lowhigh.field,compoundchangemodel.lowhigh.field)
View(compoundpercentchange.lowhigh.field)

write_csv(compoundpercentchange.lowhigh.field, file = "Nexp1_Compound%change_lowhigh_field.csv")
```

Analyze the correlation between VOC changes and other measured floral traits (e.g., flower size, color) to see if there's a relationship between nitrogen addition and a broader suite of floral traits.
```{r}

#load in floral trait data
morphdata1 <- read_csv("data/morphdata1.csv")
morphdata1.field<- read_csv("data/morphdata1.field.csv")

#combine data frames by plantid for greenhouse day time total emissions only

greenhouse.voc.morph.day <- averagePlant %>% ungroup() %>%  mutate(totalemissions = rowSums(averagetable))  %>%  mutate(plantid= toupper(str_remove(plantid, " ")), treatment=toupper(treatment), species=toupper(species)) %>% left_join(morphdata1) %>%   #treatment and species upper and lowercase in diff data frames so makes them all uppercase
            select(c("corolla_length", "corolla_width", "style_length", "max_anther", "min_anther","sepal_width", "inflo_height_cm", "totalemissions", colnames(averagetable)) ) %>% #selects morph traits and total emissions to use in correlation table
                            drop_na()
  
#correlation between vocs and morphology 
install.packages("ggcorrplot")
library(ggcorrplot)

ggcorrplot(cor(greenhouse.voc.morph.day), lab=TRUE, p.mat= cor_pmat(greenhouse.voc.morph.day) ) 
#note total emissions spelled wrong in data; correlation numbers are numbers in squares (tells you how strong the correlation is not the significance); x's cross out things that are not significant 

#can do the same thing for night, just copy code


```

